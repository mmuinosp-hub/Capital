<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Historial Global</title>
<style>
body { font-family: Arial, sans-serif; margin: 20px; background: #f9f9f9; }
h2 { margin-bottom: 10px; }
section { background: #fff; padding: 14px; border-radius: 10px; box-shadow: 0 2px 6px rgba(0,0,0,0.08); margin-bottom: 14px; }
table { border-collapse: collapse; width: 100%; margin-top: 8px; }
th, td { border: 1px solid #999; padding: 5px; text-align: center; }
select, button { padding: 6px 10px; margin: 4px; }
</style>
</head>
<body>
<nav>
  <a href="/">Inicio</a> | <a href="/player.html">Jugador</a> | <a href="/estado_jugadores.html">Estado</a> | <a href="/entregas_realizadas.html">Entregas</a>
</nav>
  
<h2>Historial Global</h2>

<section>
  <h3>Selecciona tipo de historial</h3>
  <select id="tipoHistorial">
    <option value="entregas">Entregas</option>
    <option value="produccion">Producción</option>
  </select>

  <select id="archivoSeleccionado">
    <option value="">-- Cargando --</option>
  </select>
  <button onclick="cargarArchivo()">Cargar</button>
</section>

<section id="tablaSection" style="display:none;">
  <h3>Datos del historial: <span id="nombreArchivo"></span></h3>
  <table id="tablaHistorial">
    <thead id="thead"></thead>
    <tbody id="tbody"></tbody>
  </table>
</section>

<script>
async function listarArchivos() {
  const tipoSelect = document.getElementById("tipoHistorial");
  const archivoSelect = document.getElementById("archivoSeleccionado");
  archivoSelect.innerHTML = "<option value=''>-- Cargando --</option>";

  try {
    const res = await fetch("/api/historiales");
    if (!res.ok) throw new Error("No se pudo cargar la lista de archivos");
    const data = await res.json();

    const tipo = tipoSelect.value;
    const lista = data[tipo] || [];

    archivoSelect.innerHTML = "";
    if (lista.length === 0) {
      archivoSelect.innerHTML = "<option value=''>No hay archivos disponibles</option>";
      return;
    }

    lista.forEach(f => {
      // Escapar cualquier caracter problemático
      const urlSafe = encodeURIComponent(f);
      archivoSelect.innerHTML += `<option value="${urlSafe}">${f}</option>`;
    });
  } catch (err) {
    archivoSelect.innerHTML = "<option value=''>Error cargando archivos</option>";
    console.error(err);
  }
}

document.getElementById("tipoHistorial").addEventListener("change", listarArchivos);

async function cargarArchivo() {
  const archivoSelect = document.getElementById("archivoSeleccionado");
  const archivoRaw = archivoSelect.value;
  if (!archivoRaw) return;

  const archivo = decodeURIComponent(archivoRaw);

  try {
    const res = await fetch(`/api/historiales/${archivo}`);
    if (!res.ok) throw new Error("No se pudo cargar el archivo");
    const data = await res.json();

    document.getElementById("tablaSection").style.display = "block";
    document.getElementById("nombreArchivo").textContent = archivo;

    const thead = document.getElementById("thead");
    const tbody = document.getElementById("tbody");
    tbody.innerHTML = "";

    if (archivo.startsWith("entregas_")) {
      thead.innerHTML = "<tr><th>De</th><th>Para</th><th>Trigo</th><th>Hierro</th><th>Hora</th></tr>";
      data.forEach(h => {
        tbody.innerHTML += `<tr>
          <td>${h.de}</td>
          <td>${h.para}</td>
          <td>${h.trigo}</td>
          <td>${h.hierro}</td>
          <td>${h.hora}</td>
        </tr>`;
      });
    } else if (archivo.startsWith("produccion_")) {
      thead.innerHTML = "<tr><th>Jugador</th><th>Trigo</th><th>Hierro</th><th>Proceso</th></tr>";
      for (const [nombre, j] of Object.entries(data)) {
        tbody.innerHTML += `<tr>
          <td>${nombre}</td>
          <td>${j.trigo}</td>
          <td>${j.hierro}</td>
          <td>${j.proceso ?? "-"}</td>
        </tr>`;
      }
    } else {
      thead.innerHTML = "";
      tbody.innerHTML = "<tr><td colspan='5'>Archivo desconocido</td></tr>";
    }
  } catch (err) {
    alert("Error cargando archivo");
    console.error(err);
  }
}

// Inicial
listarArchivos();
</script>

</body>
</html>
