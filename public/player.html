<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Jugador</title>
<script src="/socket.io/socket.io.js"></script>
</head>
<body>
<h1>Consola Jugador</h1>

<div id="login">
  <input id="roomId" placeholder="Sala"><br>
  <input id="nombre" placeholder="Nombre"><br>
  <input id="password" placeholder="Contraseña" type="password"><br>
  <button onclick="login()">Entrar</button>
</div>

<div id="panel" style="display:none;">
  <h2>Jugador: <span id="jugador"></span></h2>
  <h3>Recursos</h3>
  <p>Trigo: <span id="trigo"></span> | Hierro: <span id="hierro"></span></p>

  <div id="entregas" style="display:none;">
    <h3>Entregas</h3>
    <select id="to"></select><br><br>
    <input id="trigoEntregado" type="number" placeholder="Trigo a entregar">
    <input id="hierroEntregado" type="number" placeholder="Hierro a entregar">
    <button onclick="entregar()">Entregar</button>
  </div>

  <div id="produccion" style="display:none;">
    <h3>Elegir proceso</h3>
    <button onclick="elegir(1)">Proceso 1</button>
    <button onclick="elegir(2)">Proceso 2</button>
    <button onclick="elegir(3)">Proceso 3</button>
    <p id="seleccion"></p>
  </div>

  <div id="resultado" style="display:none;">
    <h3>Producción</h3>
    <p>Trigo producido: <span id="trigoProd"></span></p>
    <p>Hierro producido: <span id="hierroProd"></span></p>
  </div>
</div>

<script>
const socket = io();
let roomId, nombre;
let jugadoresSala = [];

function login() {
  roomId = document.getElementById("roomId").value;
  nombre = document.getElementById("nombre").value;
  const password = document.getElementById("password").value;

  socket.emit("loginJugador", { roomId, nombre, password }, res => {
    if (!res.success) return alert(res.message);
    document.getElementById("login").style.display = "none";
    document.getElementById("panel").style.display = "block";
    document.getElementById("jugador").innerText = nombre;
    actualizarUI(res.fase);
  });
}

function entregar() {
  const to = document.getElementById("to").value;
  const trigoCant = parseFloat(document.getElementById("trigoEntregado").value) || 0;
  const hierroCant = parseFloat(document.getElementById("hierroEntregado").value) || 0;

  if (to === nombre) return alert("No puedes enviarte recursos a ti mismo");

  // Entregar trigo
  if (trigoCant > 0) {
    socket.emit("entregar", { roomId, from: nombre, to, recurso: "trigo", cantidad: trigoCant }, res => {
      if (!res.success) alert(res.message);
    });
  }

  // Entregar hierro
  if (hierroCant > 0) {
    socket.emit("entregar", { roomId, from: nombre, to, recurso: "hierro", cantidad: hierroCant }, res => {
      if (!res.success) alert(res.message);
    });
  }

  // Limpiar campos
  document.getElementById("trigoEntregado").value = "";
  document.getElementById("hierroEntregado").value = "";
}

function elegir(proc) {
  socket.emit("elegirProceso", { roomId, nombre, proceso: proc }, res => {
    if (res.success) {
      document.getElementById("seleccion").innerText = `Elegiste proceso ${proc}`;
    } else alert(res.message);
  });
}

socket.on("updatePlayers", players => {
  if (!players[nombre]) return;

  // Actualizar recursos propios
  const j = players[nombre];
  document.getElementById("trigo").innerText = j.trigo.toFixed(1);
  document.getElementById("hierro").innerText = j.hierro.toFixed(1);
  document.getElementById("trigoProd").innerText = j.trigoProd?.toFixed(1) || 0;
  document.getElementById("hierroProd").innerText = j.hierroProd?.toFixed(1) || 0;

  // Actualizar lista de receptores
  jugadoresSala = Object.keys(players).filter(n => n !== nombre);
  const select = document.getElementById("to");
  select.innerHTML = "";
  jugadoresSala.forEach(jn => {
    const opt = document.createElement("option");
    opt.value = jn;
    opt.text = jn;
    select.add(opt);
  });
});

socket.on("updateFase", actualizarUI);

function actualizarUI(fase) {
  document.getElementById("entregas").style.display = fase === "entregas" ? "block" : "none";
  document.getElementById("produccion").style.display = fase === "produccion" ? "block" : "none";
  document.getElementById("resultado").style.display = fase === "fin" ? "block" : "none";
}
</script>
</body>
</html>
