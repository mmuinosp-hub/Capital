<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Consola del Jugador</title>
<script src="/socket.io/socket.io.js"></script>
<style>
  body { font-family: Arial, sans-serif; margin: 20px; background: #f4f6f8; }
  h2, h3 { color: #333; }
  .panel { background: white; padding: 12px; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); margin-bottom: 14px; }
  table { border-collapse: collapse; width: 100%; margin-top: 8px; }
  th, td { border: 1px solid #ccc; padding: 6px; text-align: center; }
  .boton { margin: 5px; padding: 6px 10px; border: none; border-radius: 6px; cursor: pointer; background: #1976d2; color: white; }
  .boton:hover { background: #125ea9; }
  .disabled { background: #ccc !important; cursor: not-allowed !important; }
  .estado-abierto { color: green; font-weight: bold; }
  .estado-cerrado { color: red; font-weight: bold; }
  #panelJuego { display: none; }
  #mensajeError { color: red; font-weight: bold; margin-top: 8px; }
  input, select { padding: 6px; border-radius: 6px; border: 1px solid #bbb; margin: 4px; }
  #overlay {
    position: fixed; top: 0; left: 0; width: 100%; height: 100%;
    background: rgba(0,0,0,0.5); display: none; justify-content: center; align-items: center;
  }
  #modal {
    background: white; padding: 20px; border-radius: 8px; width: 80%; max-height: 80%;
    overflow: auto; box-shadow: 0 4px 10px rgba(0,0,0,0.3);
  }
  #modal h3 { margin-top: 0; }
</style>
</head>
<body>

<h2>Consola del Jugador</h2>

<!-- === FORMULARIO DE ACCESO === -->
<div id="panelAcceso" class="panel">
  <h3>Entrar a una sala</h3>
  <form id="formAcceso">
    <label>Sala:</label> <input type="text" id="inputSala" required><br>
    <label>Jugador:</label> <input type="text" id="inputNombre" required><br>
    <label>Contraseña:</label> <input type="password" id="inputPassword" required><br>
    <button type="submit" class="boton">Entrar</button>
  </form>
  <div id="mensajeError"></div>
</div>

<!-- === PANEL PRINCIPAL === -->
<div id="panelJuego">

  <div class="panel">
    <p><b>Sala:</b> <span id="nombreSala"></span></p>
    <p><b>Jugador:</b> <span id="nombreJugador"></span></p>
    <p>Entregas: <span id="estadoEntregas" class="estado-cerrado">—</span> |
       Producción: <span id="estadoProduccion" class="estado-cerrado">—</span></p>
    <div>
      <button class="boton" id="btnEstados">📊 Estados actuales</button>
      <button class="boton" id="btnEntregasActuales">📦 Entregas actuales</button>
      <button class="boton" id="btnHistorialEstados">📜 Historial de estados</button>
      <button class="boton" id="btnHistorialEntregas">🧾 Historial de entregas</button>
    </div>
  </div>

  <div class="panel">
    <h3>Mis Recursos</h3>
    <table>
      <thead><tr><th>Trigo</th><th>Hierro</th><th>Entregas hechas</th><th>Proceso elegido</th></tr></thead>
      <tbody id="tablaJugador"></tbody>
    </table>
  </div>

  <div class="panel">
    <h3>Entregas personales</h3>
    <table id="tablaEntregasJugador">
      <thead><tr><th>Tipo</th><th>Jugador</th><th>Trigo</th><th>Hierro</th></tr></thead>
      <tbody></tbody>
    </table>
  </div>

  <div class="panel" id="panelEntregas">
    <h3>Enviar Entrega</h3>
    <form id="formEntrega">
      Para:
      <select id="para" required><option value="">Seleccionar receptor...</option></select>
      Trigo: <input id="trigo" type="number" min="0" step="any">
      Hierro: <input id="hierro" type="number" min="0" step="any">
      <button type="submit" class="boton">Enviar</button>
    </form>
  </div>

  <div class="panel" id="panelProduccion">
    <h3>Elegir Proceso de Producción</h3>
    <button class="boton" data-proceso="1">Proceso 1 (Trigo)</button>
    <button class="boton" data-proceso="2">Proceso 2 (Hierro)</button>
    <button class="boton" data-proceso="3">Proceso 3 (Simplificar)</button>
  </div>

  <div class="panel">
    <h3>Producción Potencial</h3>
    <table id="tablaProduccionPotencial">
      <thead>
        <tr><th>Proceso</th><th>Trigo producido</th><th>Hierro producido</th><th>Insumos desperdiciados</th></tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>

</div>

<!-- === MODAL === -->
<div id="overlay">
  <div id="modal">
    <h3 id="modalTitulo"></h3>
    <div id="modalContenido"></div>
    <button class="boton" onclick="cerrarModal()">Cerrar</button>
  </div>
</div>

<script>
const socket = io();
let sala, nombre;
let ultimoEstado = null;
let entregasLocales = []; // 🟢 Guardaremos aquí todas las entregas

// === LOGIN ===
document.getElementById("formAcceso").onsubmit = e => {
  e.preventDefault();
  sala = document.getElementById("inputSala").value.trim();
  nombre = document.getElementById("inputNombre").value.trim();
  const password = document.getElementById("inputPassword").value.trim();
  socket.emit("entrarJugador", { sala, nombre, password });
};

socket.on("jugadorEntrado", ({ sala: s, nombre: n }) => {
  document.getElementById("panelAcceso").style.display = "none";
  document.getElementById("panelJuego").style.display = "block";
  document.getElementById("nombreSala").textContent = s;
  document.getElementById("nombreJugador").textContent = n;
});

socket.on("error", msg => {
  document.getElementById("mensajeError").textContent = "⚠️ " + msg;
});

// === ACTUALIZAR ESTADO ===
socket.on("actualizarEstado", data => {
  ultimoEstado = data;
  const j = data.jugadores?.[nombre];
  actualizarEstadoGeneral(data);
  actualizarTablaJugador(j);
  actualizarTablaProduccion(j);
  actualizarReceptores(data);
  actualizarEntregasJugador();
});

// === ACTUALIZAR RECEPTOR ===
function actualizarReceptores(data) {
  const select = document.getElementById("para");
  const jugadores = Object.keys(data.jugadores || {}).filter(n => n !== nombre);
  select.innerHTML = `<option value="">Seleccionar receptor...</option>` +
    jugadores.map(j => `<option value="${j}">${j}</option>`).join("");
}

// === ENVIAR ENTREGA ===
document.getElementById("formEntrega").onsubmit = e => {
  e.preventDefault();
  const para = document.getElementById("para").value;
  const trigo = parseFloat(document.getElementById("trigo").value) || 0;
  const hierro = parseFloat(document.getElementById("hierro").value) || 0;
  if (!para || (trigo <= 0 && hierro <= 0)) return;

  // Enviamos al servidor
  socket.emit("enviarEntrega", { sala, de: nombre, para, trigo, hierro });

  // 🟢 Guardamos localmente (para mostrar sin depender del server)
  entregasLocales.push({
    de: nombre,
    para,
    trigo,
    hierro,
    timestamp: Date.now()
  });

  actualizarEntregasJugador(); // actualiza tabla personal
  e.target.reset();
};

// === SI RECIBE ENTREGAS DE OTROS ===
socket.on("nuevaEntrega", e => {
  entregasLocales.push({ ...e, timestamp: Date.now() });
  actualizarEntregasJugador();
});

// === PRODUCCIÓN ===
document.querySelectorAll('[data-proceso]').forEach(b => {
  b.onclick = () => {
    if (b.classList.contains("disabled")) return;
    socket.emit("elegirProceso", { sala, nombre, proceso: parseInt(b.dataset.proceso) });
  };
});

// === BOTONES ===
document.getElementById("btnEstados").onclick = () => {
  abrirModal("📊 Estados actuales", generarTablaJugadores(ultimoEstado?.jugadores || {}));
};
document.getElementById("btnEntregasActuales").onclick = () => {
  abrirModal("📦 Entregas actuales", generarTablaEntregas(entregasLocales));
};
document.getElementById("btnHistorialEstados").onclick = () => {
  abrirModal("📜 Historial de estados", generarTablaHistorial(ultimoEstado?.historialEstados || []));
};
document.getElementById("btnHistorialEntregas").onclick = () => {
  abrirModal("🧾 Historial de entregas", generarTablaEntregas(entregasLocales));
};

// === MODALES ===
function abrirModal(t, html) {
  document.getElementById("modalTitulo").textContent = t;
  document.getElementById("modalContenido").innerHTML = html || "<p>No hay datos.</p>";
  document.getElementById("overlay").style.display = "flex";
}
function cerrarModal() {
  document.getElementById("overlay").style.display = "none";
}

// === ESTADOS Y PRODUCCIÓN ===
function actualizarEstadoGeneral(data) {
  const eAb = document.getElementById("estadoEntregas");
  const pAb = document.getElementById("estadoProduccion");
  eAb.textContent = data.entregasAbiertas ? "🟢 Abiertas" : "🔴 Cerradas";
  pAb.textContent = data.produccionAbierta ? "🟢 Abierta" : "🔴 Cerrada";
  eAb.className = data.entregasAbiertas ? "estado-abierto" : "estado-cerrado";
  pAb.className = data.produccionAbierta ? "estado-abierto" : "estado-cerrado";

  document.querySelectorAll('[data-proceso]').forEach(btn => {
    if (data.produccionAbierta) {
      btn.disabled = false;
      btn.classList.remove("disabled");
    } else {
      btn.disabled = true;
      btn.classList.add("disabled");
    }
  });
}

function actualizarTablaJugador(j) {
  if (!j) return;
  document.getElementById("tablaJugador").innerHTML = `
    <tr><td>${j.trigo.toFixed(2)}</td><td>${j.hierro.toFixed(2)}</td><td>${j.entregas}</td><td>${j.proceso ?? "-"}</td></tr>`;
}

function actualizarEntregasJugador() {
  const t = document.querySelector("#tablaEntregasJugador tbody");
  if (!entregasLocales.length) {
    t.innerHTML = `<tr><td colspan="4">Sin entregas registradas</td></tr>`;
    return;
  }
  const propias = entregasLocales.filter(e => e.de === nombre || e.para === nombre);
  if (!propias.length) {
    t.innerHTML = `<tr><td colspan="4">Aún no has hecho ni recibido entregas</td></tr>`;
    return;
  }
  t.innerHTML = propias.map(e => `
    <tr>
      <td>${e.de === nombre ? "🔼 Enviada" : "🔽 Recibida"}</td>
      <td>${e.de === nombre ? e.para : e.de}</td>
      <td>${Number(e.trigo || 0).toFixed(2)}</td>
      <td>${Number(e.hierro || 0).toFixed(2)}</td>
    </tr>`).join("");
}

// === TABLA PRODUCCIÓN ===
function actualizarTablaProduccion(j) {
  if (!j) return;
  const t = document.querySelector("#tablaProduccionPotencial tbody");
  const trigo = j.trigo, hierro = j.hierro;

  const f1 = Math.min(trigo / 280, hierro / 12);
  const desp1 = `${(trigo - 280*f1).toFixed(2)} trigo, ${(hierro - 12*f1).toFixed(2)} hierro`;

  const f2 = Math.min(trigo / 120, hierro / 8);
  const desp2 = `${(trigo - 120*f2).toFixed(2)} trigo, ${(hierro - 8*f2).toFixed(2)} hierro`;

  t.innerHTML = `
    <tr><td>Proceso 1</td><td>${(575*f1).toFixed(2)}</td><td>0</td><td>${desp1}</td></tr>
    <tr><td>Proceso 2</td><td>0</td><td>${(20*f2).toFixed(2)}</td><td>${desp2}</td></tr>
    <tr><td>Proceso 3</td><td>${(trigo/2).toFixed(2)}</td><td>${(hierro/2).toFixed(2)}</td><td>-</td></tr>`;
}

// === TABLAS DE MODALES ===
function generarTablaJugadores(jugadores) {
  const filas = Object.entries(jugadores).map(([n,j]) =>
    `<tr><td>${n}</td><td>${j.trigo.toFixed(2)}</td><td>${j.hierro.toFixed(2)}</td><td>${j.entregas}</td><td>${j.proceso ?? "-"}</td></tr>`).join("");
  return `<table><thead><tr><th>Jugador</th><th>Trigo</th><th>Hierro</th><th>Entregas</th><th>Proceso</th></tr></thead><tbody>${filas}</tbody></table>`;
}

function generarTablaHistorial(historial) {
  if (!historial.length) return "<p>No hay historial.</p>";
  return `<table><thead><tr><th>Turno</th><th>Jugador</th><th>Trigo</th><th>Hierro</th><th>Proceso</th></tr></thead><tbody>` +
    historial.map(h => `<tr><td>${h.turno}</td><td>${h.nombre}</td><td>${h.trigo}</td><td>${h.hierro}</td><td>${h.proceso ?? "-"}</td></tr>`).join("") +
  `</tbody></table>`;
}

function generarTablaEntregas(entregas) {
  if (!entregas.length) return "<p>No hay entregas registradas.</p>";
  const filas = entregas.map(e => {
    const fecha = new Date(e.timestamp || Date.now());
    const hora = fecha.toLocaleTimeString();
    return `<tr>
      <td>${e.de}</td>
      <td>${e.para}</td>
      <td>${Number(e.trigo || 0).toFixed(2)}</td>
      <td>${Number(e.hierro || 0).toFixed(2)}</td>
      <td>${hora}</td>
    </tr>`;
  }).join("");
  return `<table><thead><tr><th>Emisor</th><th>Receptor</th><th>Trigo</th><th>Hierro</th><th>Hora</th></tr></thead><tbody>${filas}</tbody></table>`;
}
</script>
</body>
</html>
