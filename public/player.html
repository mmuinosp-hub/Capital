<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Consola Player</title>
  <script src="/socket.io/socket.io.js"></script>
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; }
    #salaForm, #jugadorForm, #produccionForm, #entregaForm { margin-bottom: 20px; }
    fieldset { margin-bottom: 10px; }
  </style>
</head>
<body>

<h1>Consola Player</h1>

<div id="inicio">
  <button id="btnCrearSala">Crear Sala</button>
  <button id="btnEntrarSala">Entrar en Sala</button>
</div>

<div id="salaForm" style="display:none;">
  <h2 id="salaNombre"></h2>
</div>

<div id="jugadorForm" style="display:none;">
  <h3>Entrar como jugador</h3>
  <input type="text" id="nombreJugador" placeholder="Nombre">
  <input type="password" id="passJugador" placeholder="Password">
  <button id="btnEntrarJugador">Entrar</button>
</div>

<div id="estadoJugador" style="display:none;">
  <p>Trigo disponible: <span id="trigoDisp">0</span></p>
  <p>Hierro disponible: <span id="hierroDisp">0</span></p>
  <p>Entregas realizadas: <span id="numEntregas">0</span></p>
</div>

<div id="entregaForm" style="display:none;">
  <h3>Realizar entrega</h3>
  <select id="destinatario"></select>
  <input type="number" id="trigoEntrega" placeholder="Trigo">
  <input type="number" id="hierroEntrega" placeholder="Hierro">
  <button id="btnEnviarEntrega">Enviar</button>
</div>

<div id="produccionForm" style="display:none;">
  <h3>Elegir proceso de producci√≥n</h3>
  <select id="procesoProduccion">
    <option value="1">Proceso 1</option>
    <option value="2">Proceso 2</option>
    <option value="3">Proceso 3 (por defecto)</option>
  </select>
  <button id="btnElegirProceso">Confirmar</button>
</div>

<script>
const socket = io();

let salaActual = "";
let nombreJugador = "";

// Mostrar formulario Crear/Entrar Sala
document.getElementById("btnCrearSala").onclick = () => {
  const sala = prompt("Nombre de la sala:");
  const pass = prompt("Password de la sala:");
  if (sala && pass) {
    socket.emit("crearSala", { sala, password: pass });
  }
};

document.getElementById("btnEntrarSala").onclick = () => {
  const sala = prompt("Nombre de la sala:");
  const pass = prompt("Password de la sala:");
  if (sala && pass) {
    socket.emit("entrarJugador", { sala, nombre: "__viewer__", password: pass });
    salaActual = sala;
    document.getElementById("salaNombre").innerText = `Sala: ${sala}`;
    document.getElementById("salaForm").style.display = "block";
  }
};

// Eventos Socket
socket.on("salaCreada", sala => {
  salaActual = sala;
  document.getElementById("salaNombre").innerText = `Sala: ${sala}`;
  document.getElementById("salaForm").style.display = "block";
  alert("Sala creada correctamente");
});

socket.on("jugadorEntrado", ({ sala, nombre }) => {
  if (nombre !== "__viewer__") {
    nombreJugador = nombre;
    document.getElementById("jugadorForm").style.display = "none";
    document.getElementById("estadoJugador").style.display = "block";
    document.getElementById("entregaForm").style.display = "block";
    document.getElementById("produccionForm").style.display = "block";
  }
});

socket.on("actualizarEstado", data => {
  if (!nombreJugador) return;
  const j = data.jugadores[nombreJugador];
  if (!j) return;

  document.getElementById("trigoDisp").innerText = j.trigo;
  document.getElementById("hierroDisp").innerText = j.hierro;
  document.getElementById("numEntregas").innerText = j.entregas;

  // Destinatarios para entregas
  const select = document.getElementById("destinatario");
  select.innerHTML = "";
  for (const n in data.jugadores) {
    if (n !== nombreJugador) {
      const opt = document.createElement("option");
      opt.value = n;
      opt.text = n;
      select.appendChild(opt);
    }
  }
});

// Entrar jugador
document.getElementById("btnEntrarJugador").onclick = () => {
  const nombre = document.getElementById("nombreJugador").value;
  const pass = document.getElementById("passJugador").value;
  if (nombre && pass) {
    socket.emit("entrarJugador", { sala: salaActual, nombre, password: pass });
  }
};

// Enviar entrega
document.getElementById("btnEnviarEntrega").onclick = () => {
  const para = document.getElementById("destinatario").value;
  const trigo = document.getElementById("trigoEntrega").value;
  const hierro = document.getElementById("hierroEntrega").value;
  socket.emit("enviarEntrega", { sala: salaActual, de: nombreJugador, para, trigo, hierro });
};

// Elegir proceso
document.getElementById("btnElegirProceso").onclick = () => {
  const proceso = parseInt(document.getElementById("procesoProduccion").value);
  socket.emit("elegirProceso", { sala: salaActual, nombre: nombreJugador, proceso });
};
</script>
</body>
</html>
