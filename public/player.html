<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Consola del Jugador</title>
<script src="/socket.io/socket.io.js"></script>
<style>
  body { font-family: Arial; margin: 20px; }
  table { border-collapse: collapse; width: 100%; }
  th, td { border: 1px solid #999; padding: 5px; text-align: center; }
  .boton { margin: 5px; padding: 5px 10px; }
  iframe { width: 100%; height: 400px; border: 1px solid #ccc; border-radius: 8px; }
  .panel { display: none; margin-top: 10px; }
</style>
</head>
<body>

<h2>Consola del Jugador</h2>

<p>
  Sala: <span id="nombreSala"></span><br>
  Jugador: <span id="nombreJugador"></span>
</p>

<h3>Enviar entrega</h3>
<form id="formEntrega">
  Para: <input id="para" type="text" required>
  Trigo: <input id="trigo" type="number" min="0" step="any">
  Hierro: <input id="hierro" type="number" min="0" step="any">
  <button type="submit">Enviar</button>
</form>

<p><b>Entregas realizadas:</b> <span id="entregas"></span></p>

<h3>ProducciÃ³n potencial</h3>
<p>Producciones segÃºn recursos actuales (incluyendo entregas)</p>
<table id="tablaProduccionPotencial">
  <thead>
    <tr>
      <th>Proceso</th>
      <th>Trigo producido</th>
      <th>Hierro producido</th>
      <th>Insumos desperdiciados</th>
    </tr>
  </thead>
  <tbody></tbody>
</table>

<h3>Elegir proceso</h3>
<button class="boton" data-proceso="1">Proceso 1 (Trigo)</button>
<button class="boton" data-proceso="2">Proceso 2 (Hierro)</button>
<button class="boton" data-proceso="3">Proceso 3 (Simplificar)</button>

<hr>

<!-- PANEL DE ESTADOS -->
<button class="boton" id="btnEstados">ðŸ“Š Ver estados</button>
<div id="panelEstados" class="panel">
  <iframe src="estado_jugadores.html"></iframe>
</div>

<!-- PANEL DE ENTREGAS -->
<button class="boton" id="btnEntregas">ðŸ“œ Ver entregas</button>
<div id="panelEntregas" class="panel">
  <iframe src="entregas_realizadas.html"></iframe>
</div>

<!-- PANEL DE HISTORIAL DE ESTADOS -->
<button class="boton" id="btnHistorialEstados">ðŸ“ˆ Ver historial de estados</button>
<div id="panelHistorialEstados" class="panel">
  <iframe src="historial_estados.html"></iframe>
</div>

<!-- PANEL DE HISTORIAL DE ENTREGAS -->
<button class="boton" id="btnHistorialEntregas">ðŸ“š Ver historial de entregas</button>
<div id="panelHistorialEntregas" class="panel">
  <iframe src="historial_entregas.html"></iframe>
</div>

<script>
const socket = io();
let sala, nombre;

function actualizarTablaProduccion(jugador) {
  const t = document.querySelector("#tablaProduccionPotencial tbody");
  t.innerHTML = "";

  if (!jugador) return;

  const trigo = jugador.trigo;
  const hierro = jugador.hierro;

  // Proceso 1
  let factor1 = Math.min(trigo / 280, hierro / 12);
  let prod1_trigo = 575 * factor1;
  let prod1_hierro = 0;
  let desperdicio1 = (trigo / 280 > hierro / 12)
    ? `Se desperdicia ${trigo - 280 * (hierro / 12)} de trigo`
    : (trigo / 280 < hierro / 12)
      ? `Se desperdicia ${hierro - 12 * (trigo / 280)} de hierro`
      : "Proporciones correctas";

  // Proceso 2
  let factor2 = Math.min(trigo / 120, hierro / 8);
  let prod2_trigo = 0;
  let prod2_hierro = 20 * factor2;
  let desperdicio2 = (trigo / 120 > hierro / 8)
    ? `Se desperdicia ${trigo - 120 * (hierro / 8)} de trigo`
    : (trigo / 120 < hierro / 8)
      ? `Se desperdicia ${hierro - 8 * (trigo / 120)} de hierro`
      : "Proporciones correctas";

  // Proceso 3
  let prod3_trigo = trigo / 2;
  let prod3_hierro = hierro / 2;

  t.innerHTML += `
    <tr><td>Proceso 1 (Trigo)</td><td>${prod1_trigo}</td><td>${prod1_hierro}</td><td>${desperdicio1}</td></tr>
    <tr><td>Proceso 2 (Hierro)</td><td>${prod2_trigo}</td><td>${prod2_hierro}</td><td>${desperdicio2}</td></tr>
    <tr><td>Proceso 3 (Simplificar)</td><td>${prod3_trigo}</td><td>${prod3_hierro}</td><td>-</td></tr>`;
}

document.querySelectorAll('button[data-proceso]').forEach(b => {
  b.onclick = () => socket.emit("elegirProceso", { sala, nombre, proceso: parseInt(b.dataset.proceso) });
});

document.getElementById("formEntrega").onsubmit = e => {
  e.preventDefault();
  const para = document.getElementById("para").value;
  const trigo = parseFloat(document.getElementById("trigo").value) || 0;
  const hierro = parseFloat(document.getElementById("hierro").value) || 0;
  socket.emit("enviarEntrega", { sala, de: nombre, para, trigo, hierro });
  document.getElementById("trigo").value = "";
  document.getElementById("hierro").value = "";
};

socket.on("actualizarEstado", data => {
  const j = data.jugadores[nombre];
  if (!j) return;
  document.getElementById("entregas").textContent = j.entregas;
  actualizarTablaProduccion(j);
});

sala = prompt("Introduce el nombre de la sala:");
nombre = prompt("Introduce tu nombre:");
const password = prompt("ContraseÃ±a del jugador:");
socket.emit("entrarJugador", { sala, nombre, password });
document.getElementById("nombreSala").textContent = sala;
document.getElementById("nombreJugador").textContent = nombre;

// Toggle genÃ©rico
function togglePanel(id) {
  const p = document.getElementById(id);
  p.style.display = p.style.display === "none" ? "block" : "none";
}

document.getElementById("btnEstados").onclick = () => togglePanel("panelEstados");
document.getElementById("btnEntregas").onclick = () => togglePanel("panelEntregas");
document.getElementById("btnHistorialEstados").onclick = () => togglePanel("panelHistorialEstados");
document.getElementById("btnHistorialEntregas").onclick = () => togglePanel("panelHistorialEntregas");
</script>

</body>
</html>
