<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Consola del Jugador</title>
<script src="/socket.io/socket.io.js"></script>
<style>
body { font-family: Arial; margin: 20px; }
.hidden { display: none; }
table { border-collapse: collapse; width: 100%; margin-top: 10px; }
th, td { border: 1px solid #999; padding: 5px; text-align: center; }
.boton { margin: 5px; padding: 5px 10px; cursor: pointer; border-radius: 6px; border: none; background: #1976d2; color: white; }
.boton.disabled { background: #ccc; cursor: not-allowed; }
.estado-abierto { color: green; font-weight: bold; }
.estado-cerrado { color: red; font-weight: bold; }
#overlay { display: none; position: fixed; top:0; left:0; width:100%; height:100%; background: rgba(0,0,0,0.5); justify-content: center; align-items:center; }
#modal { background:white; padding:20px; border-radius:10px; max-height:80%; overflow:auto; width:80%; }
#modal h3 { margin-top:0; }
</style>
</head>
<body>

<h2>Consola del Jugador</h2>

<div id="panelAcceso">
  <h3>Entrar a la sala</h3>
  <form id="formAcceso">
    Sala: <input id="inputSala" required><br><br>
    Nombre de jugador: <input id="inputNombre" required><br><br>
    Contraseña: <input type="password" id="inputPassword" required><br><br>
    <button type="submit" class="boton">Entrar</button>
  </form>
  <p id="mensajeError" style="color:red"></p>
</div>

<div id="panelJuego" class="hidden">
  <p>Sala: <span id="nombreSala"></span><br>
     Jugador: <span id="nombreJugador"></span></p>

  <h3>Estado actual</h3>
  <p>Entregas: <span id="estadoEntregas" class="estado-cerrado">—</span> 
     <button class="boton" id="btnEntregasActuales">Ver entregas actuales</button></p>
  <p>Producción: <span id="estadoProduccion" class="estado-cerrado">—</span></p>

  <h3>Enviar entrega</h3>
  <form id="formEntrega">
    Para:
    <select id="para" required></select>
    Trigo: <input id="trigo" type="number" min="0" step="any">
    Hierro: <input id="hierro" type="number" min="0" step="any">
    <button type="submit" class="boton">Enviar</button>
  </form>

  <h3>Entregas realizadas o recibidas</h3>
  <table id="tablaEntregasJugador">
    <thead><tr><th>Tipo</th><th>Contraparte</th><th>Trigo</th><th>Hierro</th></tr></thead>
    <tbody><tr><td colspan="4">Sin entregas aún</td></tr></tbody>
  </table>

  <h3>Producción potencial</h3>
  <table id="tablaProduccionPotencial">
    <thead><tr><th>Proceso</th><th>Trigo producido</th><th>Hierro producido</th><th>Insumos desperdiciados</th></tr></thead>
    <tbody></tbody>
  </table>

  <h3>Elegir proceso</h3>
  <button class="boton" data-proceso="1">Proceso 1 (Trigo)</button>
  <button class="boton" data-proceso="2">Proceso 2 (Hierro)</button>
  <button class="boton" data-proceso="3">Proceso 3 (Simplificar)</button>

  <hr>

  <button class="boton" id="btnEstados">📊 Ver estados actuales</button>
  <button class="boton" id="btnHistorialEstados">📈 Historial de estados</button>
  <button class="boton" id="btnHistorialEntregas">📚 Historial de entregas</button>
</div>

<!-- MODAL -->
<div id="overlay" onclick="cerrarModal()">
  <div id="modal" onclick="event.stopPropagation()">
    <h3 id="modalTitulo"></h3>
    <div id="modalContenido"></div>
    <button class="boton" onclick="cerrarModal()">Cerrar</button>
  </div>
</div>

<script>
const socket = io();
let sala, nombre;
let ultimoEstado = null;
let entregasLocales = [];
let procesoSeleccionado = null;

// === LOGIN ===
document.getElementById("formAcceso").onsubmit = e => {
  e.preventDefault();
  sala = document.getElementById("inputSala").value.trim();
  nombre = document.getElementById("inputNombre").value.trim();
  const password = document.getElementById("inputPassword").value.trim();
  socket.emit("entrarJugador", { sala, nombre, password });
};

socket.on("jugadorEntrado", ({ sala: s, nombre: n }) => {
  document.getElementById("panelAcceso").style.display = "none";
  document.getElementById("panelJuego").style.display = "block";
  document.getElementById("nombreSala").textContent = s;
  document.getElementById("nombreJugador").textContent = n;
});

socket.on("error", msg => {
  document.getElementById("mensajeError").textContent = "⚠️ " + msg;
});

// === ACTUALIZAR ESTADO ===
socket.on("actualizarEstado", data => {
  ultimoEstado = data;
  const j = data.jugadores?.[nombre];
  procesoSeleccionado = j?.proceso ?? null;
  actualizarEstadoGeneral(data);
  actualizarBotonesProceso();
  actualizarTablaJugador(j);
  actualizarTablaProduccion(j);
  actualizarReceptores(data);
  actualizarEntregasJugador();
});

// === ACTUALIZAR RECEPTORES ===
function actualizarReceptores(data) {
  const select = document.getElementById("para");
  const jugadores = Object.keys(data.jugadores || {}).filter(n => n !== nombre);
  select.innerHTML = `<option value="">Seleccionar receptor...</option>` +
    jugadores.map(j => `<option value="${j}">${j}</option>`).join("");
}

// === ENVIAR ENTREGA ===
document.getElementById("formEntrega").onsubmit = e => {
  e.preventDefault();
  const para = document.getElementById("para").value;
  const trigo = parseFloat(document.getElementById("trigo").value) || 0;
  const hierro = parseFloat(document.getElementById("hierro").value) || 0;
  if (!para || (trigo <= 0 && hierro <= 0)) return;
  socket.emit("enviarEntrega", { sala, de: nombre, para, trigo, hierro });
  entregasLocales.push({ de: nombre, para, trigo, hierro, timestamp: Date.now() });
  actualizarEntregasJugador();
  e.target.reset();
};

// === PRODUCCIÓN ===
document.querySelectorAll('[data-proceso]').forEach(b => {
  b.onclick = () => {
    if (b.classList.contains("disabled")) return;
    const proceso = parseInt(b.dataset.proceso);
    procesoSeleccionado = proceso;
    actualizarBotonesProceso();
    socket.emit("elegirProceso", { sala, nombre, proceso });
  };
});

function actualizarBotonesProceso() {
  document.querySelectorAll('[data-proceso]').forEach(b => {
    const p = parseInt(b.dataset.proceso);
    if (!ultimoEstado?.produccionAbierta) {
      b.disabled = true;
      b.classList.add("disabled");
      b.style.background = "#ccc";
      return;
    }
    b.disabled = false;
    b.classList.remove("disabled");
    if (procesoSeleccionado === p) {
      b.style.background = "#2e7d32";
      b.style.color = "white";
    } else {
      b.style.background = "#1976d2";
      b.style.color = "white";
    }
  });
}

// === BOTONES DE CONSULTA ===
document.getElementById("btnEstados").onclick = () => abrirModal("📊 Estados actuales", generarTablaJugadores(ultimoEstado?.jugadores || {}));
document.getElementById("btnEntregasActuales").onclick = () => abrirModal("📦 Entregas actuales", generarTablaEntregas(entregasLocales));
document.getElementById("btnHistorialEstados").onclick = () => abrirModal("📜 Historial de estados", generarTablaHistorial(ultimoEstado?.historial || []));
document.getElementById("btnHistorialEntregas").onclick = () => abrirModal("🧾 Historial de entregas", generarTablaEntregas(entregasLocales));

// === MODAL ===
function abrirModal(t, html) {
  document.getElementById("modalTitulo").textContent = t;
  document.getElementById("modalContenido").innerHTML = html || "<p>No hay datos.</p>";
  document.getElementById("overlay").style.display = "flex";
}
function cerrarModal() { document.getElementById("overlay").style.display = "none"; }

// === ACTUALIZAR ESTADOS Y PRODUCCIÓN ===
function actualizarEstadoGeneral(data) {
  const eAb = document.getElementById("estadoEntregas");
  const pAb = document.getElementById("estadoProduccion");
  eAb.textContent = data.entregasAbiertas ? "🟢 Abiertas" : "🔴 Cerradas";
  pAb.textContent = data.produccionAbierta ? "🟢 Abierta" : "🔴 Cerrada";
  eAb.className = data.entregasAbiertas ? "estado-abierto" : "estado-cerrado";
  pAb.className = data.produccionAbierta ? "estado-abierto" : "estado-cerrado";
  actualizarBotonesProceso();
}

function actualizarTablaJugador(j) {
  if (!j) return;
  const tbody = document.getElementById("tablaJugador");
  if (!tbody) return;
  tbody.innerHTML = `<tr><td>${j.trigo.toFixed(2)}</td><td>${j.hierro.toFixed(2)}</td><td>${j.entregas}</td><td>${j.proceso ?? "-"}</td></tr>`;
}

function actualizarEntregasJugador() {
  const t = document.querySelector("#tablaEntregasJugador tbody");
  const propias = entregasLocales.filter(e => e.de === nombre || e.para === nombre);
  if (!propias.length) {
    t.innerHTML = `<tr><td colspan="4">Sin entregas aún</td></tr>`;
    return;
  }
  t.innerHTML = propias.map(e => `
    <tr>
      <td>${e.de === nombre ? "🔼 Enviada" : "🔽 Recibida"}</td>
      <td>${e.de === nombre ? e.para : e.de}</td>
      <td>${Number(e.trigo || 0).toFixed(2)}</td>
      <td>${Number(e.hierro || 0).toFixed(2)}</td>
    </tr>`).join("");
}

function actualizarTablaProduccion(j) {
  if (!j) return;
  const t = document.querySelector("#tablaProduccionPotencial tbody");
  const trigo = j.trigo, hierro = j.hierro;
  const f1 = Math.min(trigo/280, hierro/12), f2 = Math.min(trigo/120, hierro/8);
  const desp1 = `${(trigo - 280*f1).toFixed(2)} trigo, ${(hierro - 12*f1).toFixed(2)} hierro`;
  const desp2 = `${(trigo - 120*f2).toFixed(2)} trigo, ${(hierro - 8*f2).toFixed(2)} hierro`;
  t.innerHTML = `
    <tr><td>Proceso 1</td><td>${(575*f1).toFixed(2)}</td><td>0</td><td>${desp1}</td></tr>
    <tr><td>Proceso 2</td><td>0</td><td>${(20*f2).toFixed(2)}</td><td>${desp2}</td></tr>
    <tr><td>Proceso 3</td><td>${(trigo/2).toFixed(2)}</td><td>${(hierro/2).toFixed(2)}</td><td>-</td></tr>`;
}

function generarTablaJugadores(jugadores) {
  const filas = Object.entries(jugadores).map(([n,j]) =>
    `<tr><td>${n}</td><td>${j.trigo.toFixed(2)}</td><td>${j.hierro.toFixed(2)}</td><td>${j.entregas}</td><td>${j.proceso ?? "-"}</td></tr>`).join("");
  return `<table><thead><tr><th>Jugador</th><th>Trigo</th><th>Hierro</th><th>Entregas</th><th>Proceso</th></tr></thead><tbody>${filas}</tbody></table>`;
}

function generarTablaHistorial(historial) {
  if (!historial.length) return "<p>No hay historial.</p>";
  return `<table><thead><tr><th>Turno</th><th>Jugador</th><th>Trigo</th><th>Hierro</th><th>Proceso</th></tr></thead><tbody>` +
    historial.map(h => `<tr><td>${h.turno}</td><td>${h.nombre}</td><td>${h.trigo}</td><td>${h.hierro}</td><td>${h.proceso ?? "-"}</td></tr>`).join("") +
  `</tbody></table>`;
}

function generarTablaEntregas(entregas) {
  if (!entregas.length) return "<p>No hay entregas registradas.</p>";
  const filas = entregas.map(e => {
    const fecha = new Date(e.timestamp || Date.now());
    const hora = fecha.toLocaleTimeString();
    return `<tr>
      <td>${e.de}</td><td>${e.para}</td><td>${Number(e.trigo||0).toFixed(2)}</td><td>${Number(e.hierro||0).toFixed(2)}</td><td>${hora}</td>
    </tr>`;
  }).join("");
  return `<table><thead><tr><th>Emisor</th><th>Receptor</th><th>Trigo</th><th>Hierro</th><th>Hora</th></tr></thead><tbody>${filas}</tbody></table>`;
}
</script>

</body>
</html>

