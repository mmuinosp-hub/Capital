<script>
const socket = io();
let sala = "";
let nombre = "";

function entrar() {
  sala = document.getElementById("sala").value;
  nombre = document.getElementById("nombre").value;
  const password = document.getElementById("password").value;
  socket.emit("entrarJugador", { sala, nombre, password });
}

function entregar() {
  const para = document.getElementById("destino").value;
  const trigo = parseFloat(document.getElementById("trigoEnv").value) || 0;
  const hierro = parseFloat(document.getElementById("hierroEnv").value) || 0;

  const filaPropia = jugadoresData[nombre];
  if (!filaPropia) return;

  if (trigo > filaPropia.trigo || hierro > filaPropia.hierro) {
    alert("❌ No puedes entregar más de lo que tienes.");
    return;
  }

  socket.emit("enviarEntrega", { sala, de: nombre, para, trigo, hierro });
}

function elegirProceso() {
  const proceso = parseInt(document.getElementById("proceso").value);
  socket.emit("elegirProceso", { sala, nombre, proceso });
}

let jugadoresData = {};

socket.on("actualizarEstado", (data) => {
  jugadoresData = data.jugadores;
  const tbody = document.getElementById("jugadores");
  tbody.innerHTML = "";
  const sel = document.getElementById("destino");
  sel.innerHTML = "";
  for (const [n, j] of Object.entries(data.jugadores)) {
    tbody.innerHTML += `<tr><td>${n}</td><td>${j.trigo.toFixed(2)}</td><td>${j.hierro.toFixed(2)}</td><td>${j.entregas}</td></tr>`;
    if (n !== nombre) sel.innerHTML += `<option value="${n}">${n}</option>`;
    if (n === nombre) {
      document.getElementById("trigoProd").textContent = j.trigoProd.toFixed(2);
      document.getElementById("hierroProd").textContent = j.hierroProd.toFixed(2);
    }
  }

  const hist = document.getElementById("historial");
  hist.innerHTML = "";
  for (const h of data.historial) {
    hist.innerHTML += `<tr><td>${h.de}</td><td>${h.para}</td><td>${h.trigo}</td><td>${h.hierro}</td><td>${h.hora}</td></tr>`;
  }
});

socket.on("error", msg => alert(msg));
</script>
