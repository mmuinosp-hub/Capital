<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Consola Jugador</title>
<script src="/socket.io/socket.io.js"></script>
<style>
  body { font-family: sans-serif; margin: 20px; }
  table { border-collapse: collapse; width: 100%; margin-top: 10px; }
  th, td { border: 1px solid #aaa; padding: 5px; text-align: center; }
  input, select, button { margin: 5px; }
</style>
</head>
<body>
<h1>Consola Jugador</h1>

<div>
  <label>Sala: <input id="roomId" /></label>
  <label>Jugador: <input id="nombre" /></label>
  <label>Contraseña: <input type="password" id="password" /></label>
  <button id="loginBtn">Entrar</button>
</div>

<div id="controls" style="display:none;">
  <h2>Mis Recursos</h2>
  <p>Trigo: <span id="trigo"></span> | Hierro: <span id="hierro"></span></p>

  <div id="entregasDiv">
    <h3>Realizar Entrega</h3>
    <label>Receptor: 
      <select id="receptor"></select>
    </label>
    <label>Trigo: <input type="number" id="trigoEntregado" /></label>
    <label>Hierro: <input type="number" id="hierroEntregado" /></label>
    <button id="entregarBtn">Entregar</button>
  </div>

  <div id="produccionDiv">
    <h3>Elegir Proceso de Producción</h3>
    <select id="proceso">
      <option value="1">Proceso 1</option>
      <option value="2">Proceso 2</option>
      <option value="3">Proceso 3</option>
    </select>
    <button id="procesoBtn">Seleccionar</button>
  </div>

  <h3>Mi Producción</h3>
  <p>Trigo producido: <span id="trigoProd"></span></p>
  <p>Hierro producido: <span id="hierroProd"></span></p>

  <h3>Historial de Entregas</h3>
  <table id="historialTabla">
    <thead>
      <tr>
        <th>De</th>
        <th>Para</th>
        <th>Trigo</th>
        <th>Hierro</th>
        <th>Hora</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>
</div>

<script>
const socket = io();
let roomId, nombre;

document.getElementById("loginBtn").onclick = () => {
  roomId = document.getElementById("roomId").value;
  nombre = document.getElementById("nombre").value;
  const password = document.getElementById("password").value;
  socket.emit("loginJugador", { roomId, nombre, password }, res => {
    if(res.success){
      document.getElementById("controls").style.display = "block";
      actualizarRecursos(res.jugador);
    } else alert(res.message);
  });
};

document.getElementById("entregarBtn").onclick = () => {
  const to = document.getElementById("receptor").value;
  const trigo = parseFloat(document.getElementById("trigoEntregado").value) || 0;
  const hierro = parseFloat(document.getElementById("hierroEntregado").value) || 0;
  socket.emit("entregar", { roomId, from: nombre, to, trigo, hierro }, res => {
    if(!res.success) alert(res.message);
  });
};

document.getElementById("procesoBtn").onclick = () => {
  const proceso = parseInt(document.getElementById("proceso").value);
  socket.emit("elegirProceso", { roomId, nombre, proceso }, res => {
    if(!res.success) alert(res.message);
  });
};

socket.on("updatePlayers", jugadores => {
  if(jugadores[nombre]) actualizarRecursos(jugadores[nombre]);

  // actualizar menú de receptores
  const receptorSelect = document.getElementById("receptor");
  receptorSelect.innerHTML = "";
  for(let jNombre in jugadores){
    if(jNombre !== nombre){
      const option = document.createElement("option");
      option.value = jNombre;
      option.textContent = jNombre;
      receptorSelect.appendChild(option);
    }
  }
});

socket.on("updateHistorial", historial => {
  const tbody = document.getElementById("historialTabla").querySelector("tbody");
  tbody.innerHTML = "";
  historial.forEach(entrega => {
    const tr = document.createElement("tr");
    tr.innerHTML = `<td>${entrega.from}</td><td>${entrega.to}</td>
                    <td>${entrega.trigo}</td><td>${entrega.hierro}</td>
                    <td>${entrega.timestamp}</td>`;
    tbody.appendChild(tr);
  });
});

function actualizarRecursos(jugador){
  document.getElementById("trigo").textContent = jugador.trigo;
  document.getElementById("hierro").textContent = jugador.hierro;
  document.getElementById("trigoProd").textContent = jugador.trigoProd;
  document.getElementById("hierroProd").textContent = jugador.hierroProd;
}
</script>
</body>
</html>
