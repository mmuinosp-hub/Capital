<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Jugador - Capitalismo Simulado</title>
<script src="/socket.io/socket.io.js"></script>
<style>
body { font-family: Arial, sans-serif; margin:20px; background:#f7f7f7; }
section{background:#fff;padding:12px;border-radius:8px;box-shadow:0 2px 6px rgba(0,0,0,0.06);margin-bottom:12px;}
h2,h3{margin:0 0 8px;}
label{margin-right:8px;}
button{padding:8px 12px;border-radius:6px;border:none;background:#1976d2;color:#fff;cursor:pointer;margin:6px 4px;}
.alerta{color:#b00020;font-weight:bold;margin:8px 0;}
table{width:100%;border-collapse:collapse;margin-top:8px;}
th,td{border:1px solid #eee;padding:8px;text-align:center;}
nav a{margin-right:10px;}
.small{font-size:12px;color:#555;}
.process-btn{display:inline-block;padding:10px 12px;border-radius:8px;background:#0288d1;color:#fff;border:none;cursor:pointer;margin-right:6px;}
</style>
</head>
<body>
<nav>
  <a href="/">Inicio</a> |
  <a href="/estado_jugadores.html">Estado</a> |
  <a href="/entregas_realizadas.html">Entregas</a>
</nav>

<h2>Consola del Jugador</h2>

<section id="acceso">
  <label>Sala: <input id="sala" placeholder="Sala"></label>
  <label>Nombre: <input id="nombre" placeholder="Jugador"></label>
  <label>Contrase√±a: <input id="password" type="password"></label>
  <button onclick="entrar()">Entrar</button>
</section>

<section id="panel" style="display:none;">
  <p>üéÆ Jugador: <strong id="nombreJugador"></strong> &nbsp; | &nbsp; üè† Sala: <strong id="nombreSala"></strong></p>

  <div id="alerta" class="alerta"></div>

  <table>
    <thead><tr><th>Recurso</th><th>Disponible</th><th>Producido</th></tr></thead>
    <tbody>
      <tr><td>Trigo</td><td id="trigo">0</td><td id="trigoProd">0</td></tr>
      <tr><td>Hierro</td><td id="hierro">0</td><td id="hierroProd">0</td></tr>
    </tbody>
  </table>

  <p>Entregas realizadas: <span id="entregas">0</span></p>

  <section id="entregasPanel">
    <h3>Hacer entrega</h3>
    <label>Para: <select id="destino"></select></label>
    <label>Trigo: <input id="trigoEnv" type="number" min="0"></label>
    <label>Hierro: <input id="hierroEnv" type="number" min="0"></label>
    <button onclick="entregar()">Enviar</button>
  </section>

  <section id="produccionPanel">
    <h3>Elegir proceso</h3>
    <div>
      <button class="process-btn" onclick="elegir(1)">üçû Proceso 1<br><span class="small">280T + 12H ‚Üí 575T</span></button>
      <button class="process-btn" onclick="elegir(2)">‚öôÔ∏è Proceso 2<br><span class="small">120T + 8H ‚Üí 20H</span></button>
      <button class="process-btn" onclick="elegir(3)">‚ôªÔ∏è Proceso 3<br><span class="small">Reduce a la mitad</span></button>
    </div>
  </section>

  <section>
    <h3>Historial</h3>
    <table>
      <thead><tr><th>De</th><th>Para</th><th>Trigo</th><th>Hierro</th><th>Hora</th></tr></thead>
      <tbody id="historial"></tbody>
    </table>
  </section>
</section>

<script>
const socket = io();
let sala="", nombre="";

function entrar(){
  sala = document.getElementById("sala").value.trim();
  nombre = document.getElementById("nombre").value.trim();
  const password = document.getElementById("password").value.trim();
  if(!sala||!nombre||!password) return alert("Rellena sala, nombre y contrase√±a");
  socket.emit("entrarJugador", { sala, nombre, password });
}

function entregar(){
  const para = document.getElementById("destino").value;
  const trigo = document.getElementById("trigoEnv").value;
  const hierro = document.getElementById("hierroEnv").value;
  socket.emit("enviarEntrega", { sala, de: nombre, para, trigo, hierro });
}

function elegir(p){
  socket.emit("elegirProceso", { sala, nombre, proceso: p });
}

socket.on("jugadorEntrado", ({ sala: s, nombre: n }) => {
  sala = s; nombre = n;
  document.getElementById("acceso").style.display = "none";
  document.getElementById("panel").style.display = "block";
  document.getElementById("nombreSala").textContent = s;
  document.getElementById("nombreJugador").textContent = n;
});

socket.on("actualizarEstado", data => {
  const j = data.jugadores[nombre];
  if(!j) return;

  document.getElementById("trigo").textContent = j.trigo.toFixed(2);
  document.getElementById("hierro").textContent = j.hierro.toFixed(2);
  document.getElementById("trigoProd").textContent = (j.trigoProd||0).toFixed(2);
  document.getElementById("hierroProd").textContent = (j.hierroProd||0).toFixed(2);
  document.getElementById("entregas").textContent = j.entregas;

  // Mensajes seg√∫n fase
  const alerta = document.getElementById("alerta");
  if (data.entregasAbiertas && !data.produccionAbierta) {
    alerta.textContent = "‚úÖ Entregas abiertas. Puedes enviar recursos.";
  } else if (!data.entregasAbiertas && data.produccionAbierta) {
    alerta.textContent = "‚öôÔ∏è Producci√≥n abierta. Elige un proceso.";
  } else if (!data.entregasAbiertas && !data.produccionAbierta) {
    alerta.textContent = "‚è≥ Fase cerrada. Espera al admin.";
  } else {
    alerta.textContent = "";
  }

  // Mostrar/ocultar formularios
  document.getElementById("entregasPanel").style.display = data.entregasAbiertas ? "block" : "none";
  document.getElementById("produccionPanel").style.display = data.produccionAbierta ? "block" : "none";

  // Destinatarios
  const sel = document.getElementById("destino");
  sel.innerHTML = "";
  for (const p in data.jugadores) if (p !== nombre) sel.innerHTML += `<option value="${p}">${p}</option>`;

  // Historial (solo relacionado con este jugador)
  const hist = document.getElementById("historial");
  hist.innerHTML = "";
  for (const h of data.historial.filter(e => e.de===nombre || e.para===nombre)) {
    hist.innerHTML += `<tr><td>${h.de}</td><td>${h.para}</td><td>${h.trigo}</td><td>${h.hierro}</td><td>${h.hora}</td></tr>`;
  }
});

socket.on("error", msg => alert(msg));
</script>
</body>
</html>
