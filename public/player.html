<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Consola del Jugador</title>
<script src="/socket.io/socket.io.js"></script>
<style>
  body { font-family: Arial; margin: 20px; }
  table { border-collapse: collapse; width: 100%; }
  th, td { border: 1px solid #999; padding: 5px; text-align: center; }
  .boton { margin: 5px; padding: 5px 10px; }
  #panelEstados, #panelEntregas { margin-top: 10px; display: none; }
</style>
</head>
<body>

<h2>Consola del Jugador</h2>

<p>
  Sala: <span id="nombreSala"></span><br>
  Jugador: <span id="nombreJugador"></span>
</p>

<h3>Enviar entrega</h3>
<form id="formEntrega">
  Para: <input id="para" type="text" required>
  Trigo: <input id="trigo" type="number" min="0" step="any">
  Hierro: <input id="hierro" type="number" min="0" step="any">
  <button type="submit">Enviar</button>
</form>

<p><b>Entregas realizadas:</b> <span id="entregas"></span></p>

<h3>ProducciÃ³n potencial</h3>
<p>Producciones segÃºn recursos actuales (incluyendo entregas)</p>
<table id="tablaProduccionPotencial">
  <thead>
    <tr>
      <th>Proceso</th>
      <th>Trigo producido</th>
      <th>Hierro producido</th>
      <th>Insumos desperdiciados</th>
    </tr>
  </thead>
  <tbody></tbody>
</table>

<h3>Elegir proceso</h3>
<button class="boton" data-proceso="1">Proceso 1 (Trigo)</button>
<button class="boton" data-proceso="2">Proceso 2 (Hierro)</button>
<button class="boton" data-proceso="3">Proceso 3 (Simplificar)</button>

<hr>

<!-- NUEVOS BOTONES -->
<button id="toggleEstados" class="boton">ðŸ“Š Ver estados</button>
<div id="panelEstados">
  <iframe src="estado_jugadores.html" style="width:100%; height:400px; border:1px solid #ccc; border-radius:8px;"></iframe>
</div>

<button id="toggleEntregas" class="boton">ðŸ“œ Ver entregas</button>
<div id="panelEntregas">
  <iframe src="entregas_realizadas.html" style="width:100%; height:400px; border:1px solid #ccc; border-radius:8px;"></iframe>
</div>

<script>
const socket = io();
let sala, nombre;

function actualizarTablaProduccion(jugador) {
  const t = document.querySelector("#tablaProduccionPotencial tbody");
  t.innerHTML = "";

  if (!jugador) return;

  const trigo = jugador.trigo;
  const hierro = jugador.hierro;

  // Proceso 1: 280 trigo + 12 hierro â†’ 575 trigo
  let factor1 = Math.min(trigo / 280, hierro / 12);
  let prod1_trigo = 575 * factor1;
  let prod1_hierro = 0;
  let desperdicio1 = "";
  if (trigo / 280 > hierro / 12)
    desperdicio1 = `Se desperdicia ${trigo - 280 * (hierro / 12)} de trigo`;
  else if (trigo / 280 < hierro / 12)
    desperdicio1 = `Se desperdicia ${hierro - 12 * (trigo / 280)} de hierro`;
  else desperdicio1 = "Proporciones correctas";

  // Proceso 2: 120 trigo + 8 hierro â†’ 20 hierro
  let factor2 = Math.min(trigo / 120, hierro / 8);
  let prod2_trigo = 0;
  let prod2_hierro = 20 * factor2;
  let desperdicio2 = "";
  if (trigo / 120 > hierro / 8)
    desperdicio2 = `Se desperdicia ${trigo - 120 * (hierro / 8)} de trigo`;
  else if (trigo / 120 < hierro / 8)
    desperdicio2 = `Se desperdicia ${hierro - 8 * (trigo / 120)} de hierro`;
  else desperdicio2 = "Proporciones correctas";

  // Proceso 3: simplificado
  let prod3_trigo = trigo / 2;
  let prod3_hierro = hierro / 2;

  t.innerHTML += `
    <tr><td>Proceso 1 (Trigo)</td><td>${prod1_trigo}</td><td>${prod1_hierro}</td><td>${desperdicio1}</td></tr>
    <tr><td>Proceso 2 (Hierro)</td><td>${prod2_trigo}</td><td>${prod2_hierro}</td><td>${desperdicio2}</td></tr>
    <tr><td>Proceso 3 (Simplificar)</td><td>${prod3_trigo}</td><td>${prod3_hierro}</td><td>-</td></tr>
  `;
}

document.querySelectorAll('button[data-proceso]').forEach(b => {
  b.onclick = () => {
    const proceso = parseInt(b.dataset.proceso);
    socket.emit("elegirProceso", { sala, nombre, proceso });
  };
});

document.getElementById("formEntrega").onsubmit = e => {
  e.preventDefault();
  const para = document.getElementById("para").value;
  const trigo = parseFloat(document.getElementById("trigo").value) || 0;
  const hierro = parseFloat(document.getElementById("hierro").value) || 0;
  socket.emit("enviarEntrega", { sala, de: nombre, para, trigo, hierro });
  document.getElementById("trigo").value = "";
  document.getElementById("hierro").value = "";
};

socket.on("actualizarEstado", data => {
  const j = data.jugadores[nombre];
  if (!j) return;
  document.getElementById("entregas").textContent = j.entregas;
  actualizarTablaProduccion(j);
});

sala = prompt("Introduce el nombre de la sala:");
nombre = prompt("Introduce tu nombre:");
const password = prompt("ContraseÃ±a del jugador:");
socket.emit("entrarJugador", { sala, nombre, password });
document.getElementById("nombreSala").textContent = sala;
document.getElementById("nombreJugador").textContent = nombre;

// Toggle panels
const toggleEstados = document.getElementById("toggleEstados");
const toggleEntregas = document.getElementById("toggleEntregas");
const panelEstados = document.getElementById("panelEstados");
const panelEntregas = document.getElementById("panelEntregas");

toggleEstados.addEventListener("click", () => {
  panelEstados.style.display = panelEstados.style.display === "none" ? "block" : "none";
});
toggleEntregas.addEventListener("click", () => {
  panelEntregas.style.display = panelEntregas.style.display === "none" ? "block" : "none";
});
</script>

</body>
</html>
