<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Jugador - Capitalismo Simulado</title>
<script src="/socket.io/socket.io.js"></script>
<style>
body{font-family:Arial,sans-serif;margin:20px;background:#f9f9f9;}
section{background:#fff;padding:14px;border-radius:10px;box-shadow:0 2px 6px rgba(0,0,0,0.08);margin-bottom:14px;}
h2,h3{margin:0 0 10px 0;}
button{padding:8px 14px;border-radius:8px;border:none;background:#1976d2;color:#fff;cursor:pointer;margin:6px 4px;}
button.secondary{background:#616161;}
table{width:100%;border-collapse:collapse;margin-top:8px;}
th,td{border:1px solid #ddd;padding:6px;text-align:center;}
.hidden{display:none;}
.enviada{background:#e3f2fd;}
.recibida{background:#e8f5e9;}
.proceso-info{font-size:0.9em;color:#333;margin-top:4px;}
</style>
</head>
<body>
<h2>Consola del Jugador</h2>

<!-- ENTRADA A SALA -->
<section id="acceso">
  <h3>Entrar a sala</h3>
  <label>Sala: <input id="sala" placeholder="Nombre de la sala"></label>
  <label>Jugador: <input id="jugador" placeholder="Tu nombre"></label>
  <label>Contrase√±a: <input id="password" type="password" placeholder="Tu contrase√±a"></label>
  <button onclick="entrar()">Entrar</button>
</section>

<!-- INFORMACI√ìN DEL JUGADOR -->
<section id="panel" class="hidden">
  <h3>Informaci√≥n del jugador</h3>
  <p><strong>Sala:</strong> <span id="nombreSala"></span></p>
  <p><strong>Jugador:</strong> <span id="nombreJugador"></span></p>
  <table>
    <tr><th>Trigo</th><th>Hierro</th></tr>
    <tr><td id="trigo"></td><td id="hierro"></td></tr>
  </table>
  <p>Estado actual: <strong id="estadoJuego"></strong></p>
</section>

<!-- ENTREGAS -->
<section id="entregasPanel" class="hidden">
  <h3>Entregas</h3>
  <div id="avisoEntregas"></div>

  <div id="formEntrega">
    <label>Destinatario: <input id="destinatario" placeholder="Jugador destino"></label>
    <label>Recurso: 
      <select id="recurso">
        <option value="trigo">Trigo</option>
        <option value="hierro">Hierro</option>
      </select>
    </label>
    <label>Cantidad: <input id="cantidad" type="number" min="0"></label>
    <button onclick="entregar()">Enviar entrega</button>
  </div>

  <h4>Tus entregas</h4>
  <table>
    <thead>
      <tr><th>Tipo</th><th>Jugador</th><th>Recurso</th><th>Cantidad</th></tr>
    </thead>
    <tbody id="misEntregas"></tbody>
  </table>
</section>

<!-- PRODUCCI√ìN -->
<section id="produccionPanel" class="hidden">
  <h3>Producci√≥n</h3>
  <div id="avisoProduccion"></div>

  <div id="formProduccion">
    <div>
      <button onclick="producir('trigo')">üåæ Producir Trigo</button>
      <div id="infoTrigo" class="proceso-info"></div>
    </div>
    <div>
      <button onclick="producir('hierro')">‚õèÔ∏è Producir Hierro</button>
      <div id="infoHierro" class="proceso-info"></div>
    </div>
    <div>
      <button onclick="producir('simplificar')">‚ôªÔ∏è Simplificar</button>
      <div id="infoSimplificar" class="proceso-info"></div>
    </div>
  </div>
</section>

<script>
const socket = io();
let salaActual="", jugadorActual="";
let recursos = { trigo:0, hierro:0 };

function entrar(){
  salaActual = document.getElementById("sala").value.trim();
  jugadorActual = document.getElementById("jugador").value.trim();
  const password = document.getElementById("password").value.trim();
  if(!salaActual || !jugadorActual || !password) return alert("Completa todos los campos.");
  socket.emit("entrarJugador", { sala:salaActual, nombre:jugadorActual, password });
}

function entregar(){
  const dest = document.getElementById("destinatario").value.trim();
  const recurso = document.getElementById("recurso").value;
  const cantidad = parseFloat(document.getElementById("cantidad").value);
  if(!dest || cantidad<=0) return alert("Datos inv√°lidos");
  socket.emit("entrega",{ sala:salaActual, origen:jugadorActual, destino:dest, recurso, cantidad });
}

function producir(tipo){
  socket.emit("producir",{ sala:salaActual, jugador:jugadorActual, tipo });
}

socket.on("jugadorEntrado", ({ sala, jugador, datos })=>{
  document.getElementById("acceso").classList.add("hidden");
  document.getElementById("panel").classList.remove("hidden");
  document.getElementById("entregasPanel").classList.remove("hidden");
  document.getElementById("produccionPanel").classList.remove("hidden");
  document.getElementById("nombreSala").textContent = sala;
  document.getElementById("nombreJugador").textContent = jugador;
  actualizarRecursos(datos);
});

socket.on("actualizarEstado", data=>{
  const j = data.jugadores[jugadorActual];
  if(!j) return;

  actualizarRecursos(j);

  const eAb = data.entregasAbiertas;
  const pAb = data.produccionAbierta;
  document.getElementById("estadoJuego").textContent = 
    eAb ? "Fase de Entregas" : pAb ? "Fase de Producci√≥n" : "Esperando pr√≥xima ronda";

  document.getElementById("formEntrega").style.display = eAb ? "block" : "none";
  document.getElementById("avisoEntregas").textContent = eAb ? "" : "üì¶ Entregas cerradas";
  document.getElementById("formProduccion").style.display = pAb ? "block" : "none";
  document.getElementById("avisoProduccion").textContent = pAb ? "" : "‚öôÔ∏è Producci√≥n cerrada";

  // Mostrar entregas propias
  const tbody = document.getElementById("misEntregas");
  tbody.innerHTML = "";
  for(const ent of data.entregas){
    if(ent.origen === jugadorActual){
      tbody.innerHTML += `<tr class="enviada"><td>üì§ Enviada</td><td>${ent.destino}</td><td>${ent.recurso}</td><td>${ent.cantidad}</td></tr>`;
    }
    else if(ent.destino === jugadorActual){
      tbody.innerHTML += `<tr class="recibida"><td>üì• Recibida</td><td>${ent.origen}</td><td>${ent.recurso}</td><td>${ent.cantidad}</td></tr>`;
    }
  }

  // Actualizar info de procesos
  actualizarInfoProcesos();
});

socket.on("error", msg => alert(msg));

function actualizarRecursos(j){
  recursos.trigo = j.trigo;
  recursos.hierro = j.hierro;
  document.getElementById("trigo").textContent = j.trigo.toFixed(2);
  document.getElementById("hierro").textContent = j.hierro.toFixed(2);
  actualizarInfoProcesos();
}

function actualizarInfoProcesos(){
  const t = recursos.trigo;
  const h = recursos.hierro;

  // Supongamos las reglas:
  // 1. producir trigo: trigo_final = trigo + hierro*0.5
  // 2. producir hierro: hierro_final = hierro + trigo*0.5
  // 3. simplificar: ambos se reducen a la mitad

  document.getElementById("infoTrigo").textContent = 
    `Resultado estimado ‚Üí üåæ ${(t + h*0.5).toFixed(2)} trigo total, ‚õèÔ∏è ${h.toFixed(2)} hierro.`;

  document.getElementById("infoHierro").textContent = 
    `Resultado estimado ‚Üí üåæ ${t.toFixed(2)} trigo, ‚õèÔ∏è ${(h + t*0.5).toFixed(2)} hierro total.`;

  document.getElementById("infoSimplificar").textContent = 
    `Resultado estimado ‚Üí üåæ ${(t/2).toFixed(2)} trigo, ‚õèÔ∏è ${(h/2).toFixed(2)} hierro.`;
}
</script>
</body>
</html>
