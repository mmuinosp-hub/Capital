<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8" />
<title>Jugador - Capitalismo simulado</title>
<script src="/socket.io/socket.io.js"></script>
<style>
  body{font-family:Arial, sans-serif;margin:16px}
  table{border-collapse:collapse;width:100%}
  th,td{border:1px solid #ccc;padding:6px;text-align:center}
  input,select,button{margin:6px}
</style>
</head>
<body>
<h1>Consola Jugador</h1>

<div>
  Sala: <input id="roomId" /> 
  Jugador: <input id="nombre" /> 
  Contraseña: <input id="password" type="password" />
  <button id="loginBtn">Entrar</button>
</div>

<div id="panel" style="display:none">
  <h2>Jugador: <span id="miNombre"></span></h2>

  <p>Recursos disponibles: Trigo: <span id="trigo">0</span> | Hierro: <span id="hierro">0</span> | Entregas realizadas: <span id="entregasRealizadas">0</span></p>

  <div id="entregarDiv">
    <h3>Realizar entrega</h3>
    Receptor: <select id="receptor"></select>
    Trigo: <input id="trigoEntregado" type="number" />
    Hierro: <input id="hierroEntregado" type="number" />
    <button id="entregarBtn">Entregar</button>
  </div>

  <div id="produccionDiv">
    <h3>Elegir proceso (solo en fase producción)</h3>
    <select id="proceso">
      <option value="1">Proceso 1 (solo trigo)</option>
      <option value="2">Proceso 2 (solo hierro)</option>
      <option value="3">Proceso 3 (mitad de cada insumo)</option>
    </select>
    <button id="elegirBtn">Elegir</button>
  </div>

  <h3>Mi producción (última)</h3>
  <p>Trigo producido: <span id="trigoProd">0</span> | Hierro producido: <span id="hierroProd">0</span></p>

  <h3>Historial de entregas</h3>
  <table id="histTable">
    <thead><tr><th>De</th><th>Para</th><th>Trigo</th><th>Hierro</th><th>Hora</th></tr></thead>
    <tbody></tbody>
  </table>
</div>

<script>
const socket = io();
let roomId, nombre;

document.getElementById("loginBtn").onclick = () => {
  roomId = document.getElementById("roomId").value.trim();
  nombre = document.getElementById("nombre").value.trim();
  const pass = document.getElementById("password").value;
  if(!roomId || !nombre){ alert("Sala y nombre requeridos"); return; }
  socket.emit("loginJugador", { roomId, nombre, password: pass }, res => {
    if(res.success){
      document.getElementById("panel").style.display = "block";
      document.getElementById("miNombre").textContent = nombre;
      actualizarRecursos(res.jugador);
    } else alert(res.message || "error");
  });
};

document.getElementById("entregarBtn").onclick = () => {
  const to = document.getElementById("receptor").value;
  const trigo = parseFloat(document.getElementById("trigoEntregado").value) || 0;
  const hierro = parseFloat(document.getElementById("hierroEntregado").value) || 0;
  socket.emit("entregar", { roomId, from: nombre, to, trigo, hierro }, res => {
    if(!res.success) alert(res.message);
    else {
      document.getElementById("trigoEntregado").value = "";
      document.getElementById("hierroEntregado").value = "";
    }
  });
};

document.getElementById("elegirBtn").onclick = () => {
  const proc = Number(document.getElementById("proceso").value);
  socket.emit("elegirProceso", { roomId, nombre, proceso: proc }, res => {
    if(!res.success) alert(res.message);
    else alert("Proceso enviado: " + proc);
  });
};

socket.on("updatePlayers", jugadores => {
  const mi = jugadores[nombre];
  if(mi) actualizarRecursos(mi);

  // llenar receptor con nombres (excepto yo)
  const sel = document.getElementById("receptor");
  sel.innerHTML = "";
  for(const n in jugadores){
    if(n === nombre) continue;
    const opt = document.createElement("option");
    opt.value = n; opt.textContent = n;
    sel.appendChild(opt);
  }
});

socket.on("updateHistorial", historial => {
  const tbody = document.querySelector("#histTable tbody");
  tbody.innerHTML = "";
  historial.forEach(e => {
    const tr = document.createElement("tr");
    tr.innerHTML = `<td>${e.from}</td><td>${e.to}</td><td>${e.trigo}</td><td>${e.hierro}</td><td>${e.timestamp}</td>`;
    tbody.appendChild(tr);
  });
});

socket.on("produccionResultados", resultados => {
  // mostrar mi propio resultado si está
  const r = resultados.find(x => x.jugador === nombre);
  if(r){
    document.getElementById("trigoProd").textContent = Number(r.trigoProd).toFixed(4);
    document.getElementById("hierroProd").textContent = Number(r.hierroProd).toFixed(4);
    alert(`Producción concluida. Trigo producido: ${r.trigoProd.toFixed(4)}, Hierro producido: ${r.hierroProd.toFixed(4)}`);
  }
});

function actualizarRecursos(j){
  document.getElementById("trigo").textContent = Number(j.trigo).toFixed(4);
  document.getElementById("hierro").textContent = Number(j.hierro).toFixed(4);
  document.getElementById("trigoProd").textContent = Number(j.trigoProd||0).toFixed(4);
  document.getElementById("hierroProd").textContent = Number(j.hierroProd||0).toFixed(4);
  document.getElementById("entregasRealizadas").textContent = j.entregas || 0;
}
</script>
</body>
</html>
