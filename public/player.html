<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Jugador - Capitalismo Simulado</title>
<script src="/socket.io/socket.io.js"></script>
<style>
body{font-family:Arial,sans-serif;margin:20px;background:#f9f9f9;}
section{background:#fff;padding:14px;border-radius:10px;box-shadow:0 2px 6px rgba(0,0,0,0.08);margin-bottom:14px;}
h2,h3{margin:0 0 10px 0;}
button{padding:8px 14px;border-radius:8px;border:none;background:#1976d2;color:#fff;cursor:pointer;margin:6px 4px;}
button.secondary{background:#616161;}
table{width:100%;border-collapse:collapse;margin-top:8px;}
th,td{border:1px solid #ddd;padding:6px;text-align:center;}
.hidden{display:none;}
.enviada{background:#e3f2fd;}
.recibida{background:#e8f5e9;}
.seleccionado{background:#c8e6c9;}
</style>
</head>
<body>
<nav>
  <a href="/">Inicio</a> |
  <a href="/player.html">Jugador</a> |
  <a href="/estado_jugadores.html">Estado</a> |
  <a href="/entregas_realizadas.html">Entregas</a>
</nav>
<h2>Consola del Jugador</h2>

<section id="acceso">
  <h3>Entrar a sala</h3>
  <label>Sala: <input id="sala" placeholder="Nombre de la sala"></label>
  <label>Jugador: <input id="jugador" placeholder="Tu nombre"></label>
  <label>Contraseña: <input id="password" type="password" placeholder="Tu contraseña"></label>
  <button onclick="entrar()">Entrar</button>
</section>

<section id="panel" class="hidden">
  <h3>Información del jugador</h3>
  <p><strong>Sala:</strong> <span id="nombreSala"></span></p>
  <p><strong>Jugador:</strong> <span id="nombreJugador"></span></p>
  <table>
    <tr><th>Trigo</th><th>Hierro</th></tr>
    <tr><td id="trigo"></td><td id="hierro"></td></tr>
  </table>
  <p>Estado actual: <strong id="estadoJuego"></strong></p>
</section>

<section id="entregasPanel" class="hidden">
  <h3>Entregas</h3>
  <div id="avisoEntregas"></div>
  <div>
    <label>Trigo a entregar: <input id="trigoEntrega" type="number" min="0" value="0"></label>
    <label>Hierro a entregar: <input id="hierroEntrega" type="number" min="0" value="0"></label>
    <label>Destinatario: <select id="destinatario"></select></label>
    <button onclick="entregar()">Enviar entrega</button>
  </div>
  <h4>Resumen neto de entregas</h4>
  <p>Trigo neto: <span id="netoTrigo">0</span></p>
  <p>Hierro neto: <span id="netoHierro">0</span></p>
</section>

<section id="produccionPanel" class="hidden">
  <h3>Producción potencial</h3>
  <p>Producciones según recursos actuales (incluyendo entregas)</p>
  <table>
    <thead>
      <tr><th>Proceso</th><th>Trigo producido</th><th>Hierro producido</th><th>Insumos desperdiciados</th></tr>
    </thead>
    <tbody id="tablaProduccionPotencial"></tbody>
  </table>
  <div>
    <button onclick="producir(1)">🌾 Proceso 1: Trigo</button>
    <button onclick="producir(2)">⛏️ Proceso 2: Hierro</button>
    <button onclick="producir(3)">♻️ Proceso 3: Simplificar</button>
  </div>
</section>

<script>
const socket = io();
let salaActual="", jugadorActual="";
let recursos = { trigo:0, hierro:0 };
let netoEntregadoRecibido = { trigo:0, hierro:0 };
let procesoElegido = null;

function entrar(){
  salaActual = document.getElementById("sala").value.trim();
  jugadorActual = document.getElementById("jugador").value.trim();
  const password = document.getElementById("password").value.trim();
  if(!salaActual || !jugadorActual || !password) return alert("Completa todos los campos.");
  socket.emit("entrarJugador", { sala:salaActual, nombre:jugadorActual, password });
}

function entregar(){
  const trigo = parseFloat(document.getElementById("trigoEntrega").value) || 0;
  const hierro = parseFloat(document.getElementById("hierroEntrega").value) || 0;
  const dest = document.getElementById("destinatario").value;
  if(!dest || (trigo<=0 && hierro<=0)) return alert("Datos inválidos");
  socket.emit("enviarEntrega",{ sala:salaActual, de:jugadorActual, para:dest, trigo, hierro });
}

function producir(tipo){
  procesoElegido = tipo;
  socket.emit("elegirProceso",{ sala:salaActual, nombre:jugadorActual, proceso:tipo });
  actualizarProduccionPotencial();
}

socket.on("jugadorEntrado", ({ sala, nombre, datos, jugadores })=>{
  document.getElementById("acceso").classList.add("hidden");
  document.getElementById("panel").classList.remove("hidden");
  document.getElementById("entregasPanel").classList.remove("hidden");
  document.getElementById("produccionPanel").classList.remove("hidden");
  document.getElementById("nombreSala").textContent = sala;
  document.getElementById("nombreJugador").textContent = nombre;
  actualizarRecursos(datos);
  actualizarDestinatarios(Object.keys(jugadores));
});

socket.on("actualizarEstado", data=>{
  const j = data.jugadores[jugadorActual];
  if(!j) return;
  actualizarRecursos(j);

  // Actualizar destinatarios
  actualizarDestinatarios(Object.keys(data.jugadores));

  // Estado juego
  document.getElementById("estadoJuego").textContent = 
    data.entregasAbiertas ? "Fase de Entregas" : data.produccionAbierta ? "Fase de Producción" : "Esperando próxima ronda";

  document.getElementById("avisoEntregas").textContent = data.entregasAbiertas ? "" : "📦 Entregas cerradas";

  // Calcular neto entregas
  netoEntregadoRecibido.trigo = 0;
  netoEntregadoRecibido.hierro = 0;
  for(const ent of data.historial){
    if(ent.de===jugadorActual){ netoEntregadoRecibido.trigo -= ent.trigo; netoEntregadoRecibido.hierro -= ent.hierro; }
    if(ent.para===jugadorActual){ netoEntregadoRecibido.trigo += ent.trigo; netoEntregadoRecibido.hierro += ent.hierro; }
  }
  document.getElementById("netoTrigo").textContent = netoEntregadoRecibido.trigo.toFixed(2);
  document.getElementById("netoHierro").textContent = netoEntregadoRecibido.hierro.toFixed(2);

  actualizarProduccionPotencial();
});

socket.on("error", msg => alert(msg));

function actualizarDestinatarios(jugadores){
  const sel = document.getElementById("destinatario");
  sel.innerHTML = '<option value="">--Selecciona--</option>';
  for(const j of jugadores){ if(j!==jugadorActual) sel.innerHTML += `<option value="${j}">${j}</option>`; }
}

function actualizarRecursos(j){
  recursos.trigo = j.trigo;
  recursos.hierro = j.hierro;
  document.getElementById("trigo").textContent = j.trigo.toFixed(2);
  document.getElementById("hierro").textContent = j.hierro.toFixed(2);
  actualizarProduccionPotencial();
}

function actualizarProduccionPotencial(){
  const tDisp = recursos.trigo + netoEntregadoRecibido.trigo;
  const hDisp = recursos.hierro + netoEntregadoRecibido.hierro;

  const prod1 = 575 * Math.min(tDisp/280, hDisp/12);
  const prod2 = 20 * Math.min(tDisp/120, hDisp/8);
  const prod3t = tDisp/2;
  const prod3h = hDisp/2;

  // Desperdicios exactos
  let desp1;
  if(tDisp/280 > hDisp/12){ desp1 = tDisp - 280*hDisp/12; }
  else if(tDisp/280 < hDisp/12){ desp1 = hDisp - 12*tDisp/280; }
  else { desp1 = 0; }

  let desp2;
  if(tDisp/120 > hDisp/8){ desp2 = tDisp - 120*hDisp/8; }
  else if(tDisp/120 < hDisp/8){ desp2 = hDisp - 8*tDisp/120; }
  else { desp2 = 0; }

  const tbody = document.getElementById("tablaProduccionPotencial");
  tbody.innerHTML = `
<tr class="${procesoElegido===1?'seleccionado':''}">
  <td>Proceso 1 (Trigo)</td>
  <td>${prod1.toFixed(10)}</td>
  <td>0</td>
  <td>${desp1!==0?"Se desperdicia "+desp1:"No hay desperdicio"}</td>
</tr>
<tr class="${procesoElegido===2?'seleccionado':''}">
  <td>Proceso 2 (Hierro)</td>
  <td>0</td>
  <td>${prod2.toFixed(10)}</td>
  <td>${desp2!==0?"Se desperdicia "+desp2:"No hay desperdicio"}</td>
</tr>
<tr class="${procesoElegido===3?'seleccionado':''}">
  <td>Proceso 3 (Simplificar)</td>
  <td>${prod3t.toFixed(10)}</td>
  <td>${prod3h.toFixed(10)}</td>
  <td>No hay desperdicio</td>
</tr>`;
}
</script>
</body>
</html>
