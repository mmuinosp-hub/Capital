<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Administrador</title>
<script src="/socket.io/socket.io.js"></script>
<style>
  body { font-family: Arial; background: #f4f6f8; color: #222; margin: 20px; }
  h2 { text-align: center; }
  .panel, .panelLogin, .panelAcceso, .info-box { background: white; border-radius: 10px; padding: 15px; box-shadow: 0 2px 6px rgba(0,0,0,0.1); margin-bottom: 20px; }
  .boton { background: #1976d2; color: white; border: none; border-radius: 6px; padding: 8px 14px; cursor: pointer; margin: 5px; }
  .boton:hover { background: #1565c0; }
  .cerrado { color: red; font-weight: bold; }
  .abierto { color: green; font-weight: bold; }
  table { border-collapse: collapse; width: 100%; background: white; margin-top: 10px; }
  th, td { border: 1px solid #ccc; padding: 6px; text-align: center; }
  .botonera { text-align: center; margin-top: 20px; }
  input { padding: 6px; margin: 5px; }
</style>
</head>
<body>

<h2>Panel del Administrador</h2>

<!-- Panel de elecci贸n inicial -->
<div id="panelAcceso" class="panelAcceso">
  <p>驴Qu茅 deseas hacer?</p>
  <button class="boton" id="crearSala">Crear sala nueva</button>
  <button class="boton" id="entrarSala">Entrar en una sala existente</button>
</div>

<!-- Formulario de login -->
<div id="panelLogin" class="panelLogin" style="display:none;">
  <p><b id="tituloLogin"></b></p>
  <form id="formLogin">
    <label>Sala:</label><br>
    <input type="text" id="nombreSala" required><br>
    <label>Contrase帽a:</label><br>
    <input type="password" id="claveSala" required><br><br>
    <button type="submit" class="boton">Entrar</button>
  </form>
</div>

<!-- Panel principal (una vez dentro de la sala) -->
<div id="panelPrincipal" style="display:none;">
  <div class="info-box">
    <p><b>Sala:</b> <span id="salaActual"></span></p>
    <p>
      Entregas: <span id="estadoEntregas" class="cerrado">Desconocido</span> |
      Producci贸n: <span id="estadoProduccion" class="cerrado">Desconocido</span>
    </p>
  </div>

  <div class="panel">
    <h3>A帽adir jugador</h3>
    <form id="formJugador">
      <input type="text" id="nombreJugador" placeholder="Nombre del jugador" required>
      <input type="password" id="claveJugador" placeholder="Contrase帽a" required>
      <button type="submit" class="boton">A帽adir</button>
    </form>
  </div>

  <div class="panel">
    <h3>Control general</h3>
    <button id="abrirProduccion" class="boton">Abrir producci贸n</button>
    <button id="cerrarProduccion" class="boton">Cerrar producci贸n</button>
    <button id="abrirEntregas" class="boton">Abrir entregas</button>
    <button id="cerrarEntregas" class="boton">Cerrar entregas</button>
    <button id="avanzarTurno" class="boton">Avanzar turno</button>
  </div>

  <div class="botonera">
    <button class="boton" id="btnEstados"> Estados actuales</button>
    <button class="boton" id="btnEntregasAct"> Entregas actuales</button>
    <button class="boton" id="btnHistorialEstados"> Historial de estados</button>
    <button class="boton" id="btnHistorialEntregas"> Historial de entregas</button>
  </div>

  <div id="panelDatos" class="panel" style="display:none;">
    <div id="contenidoPanel"></div>
  </div>
</div>

<script>
const socket = io();
let creando = false;
let sala = null;
let ultimoEstado = {};
let panelVisible = null;

// === Etapa 1: Elecci贸n inicial ===
document.getElementById("crearSala").onclick = () => {
  creando = true;
  document.getElementById("panelAcceso").style.display = "none";
  document.getElementById("tituloLogin").textContent = "Crear nueva sala";
  document.getElementById("panelLogin").style.display = "block";
};
document.getElementById("entrarSala").onclick = () => {
  creando = false;
  document.getElementById("panelAcceso").style.display = "none";
  document.getElementById("tituloLogin").textContent = "Entrar en una sala existente";
  document.getElementById("panelLogin").style.display = "block";
};

// === Etapa 2: Formulario de acceso ===
document.getElementById("formLogin").onsubmit = e => {
  e.preventDefault();
  sala = document.getElementById("nombreSala").value.trim();
  const clave = document.getElementById("claveSala").value.trim();
  if (!sala || !clave) return alert("Completa todos los campos");
  document.getElementById("panelLogin").style.display = "none";
  document.getElementById("panelPrincipal").style.display = "block";
  document.getElementById("salaActual").textContent = sala;
  socket.emit(creando ? "crearSala" : "entrarSalaAdmin", { sala, clave });
  socket.emit("pedirEstadoAdmin", sala);
};

// === A帽adir jugador ===
document.getElementById("formJugador").onsubmit = e => {
  e.preventDefault();
  const nombre = document.getElementById("nombreJugador").value.trim();
  const clave = document.getElementById("claveJugador").value.trim();
  if (!nombre || !clave) return;
  socket.emit("agregarJugador", { sala, nombre, clave });
  document.getElementById("nombreJugador").value = "";
  document.getElementById("claveJugador").value = "";
};

// === Control de estados ===
document.getElementById("abrirProduccion").onclick = () => socket.emit("abrirProduccion", sala);
document.getElementById("cerrarProduccion").onclick = () => socket.emit("cerrarProduccion", sala);
document.getElementById("abrirEntregas").onclick = () => socket.emit("abrirEntregas", sala);
document.getElementById("cerrarEntregas").onclick = () => socket.emit("cerrarEntregas", sala);
document.getElementById("avanzarTurno").onclick = () => socket.emit("avanzarTurno", sala);

// === Actualizaci贸n de estado general ===
socket.on("estadoSala", data => {
  ultimoEstado = data;
  document.getElementById("estadoEntregas").textContent = data.entregasAbiertas ? "Abiertas" : "Cerradas";
  document.getElementById("estadoEntregas").className = data.entregasAbiertas ? "abierto" : "cerrado";
  document.getElementById("estadoProduccion").textContent = data.produccionAbierta ? "Abierta" : "Cerrada";
  document.getElementById("estadoProduccion").className = data.produccionAbierta ? "abierto" : "cerrado";
});

// === Mostrar / ocultar panel ===
function togglePanel(id, html) {
  const panel = document.getElementById("panelDatos");
  const contenido = document.getElementById("contenidoPanel");
  if (panelVisible === id) {
    panel.style.display = "none";
    panelVisible = null;
  } else {
    contenido.innerHTML = html;
    panel.style.display = "block";
    panelVisible = id;
  }
}

// === Botones de visualizaci贸n ===
document.getElementById("btnEstados").onclick = () => {
  const jugadores = ultimoEstado.jugadores || {};
  const filas = Object.entries(jugadores).map(([n,j]) =>
    `<tr><td>${n}</td><td>${j.trigo.toFixed(2)}</td><td>${j.hierro.toFixed(2)}</td><td>${j.entregas}</td><td>${j.proceso ?? "-"}</td></tr>`
  ).join("");
  togglePanel("estados", `<h3> Estados actuales</h3>
    <table><thead><tr><th>Jugador</th><th>Trigo</th><th>Hierro</th><th>Entregas</th><th>Proceso</th></tr></thead><tbody>${filas}</tbody></table>`);
};

document.getElementById("btnEntregasAct").onclick = () => {
  const entregas = ultimoEstado.historial || [];
  const filas = entregas.map(e =>
    `<tr><td>${e.de}</td><td>${e.para}</td><td>${e.trigo}</td><td>${e.hierro}</td><td>${e.hora}</td></tr>`
  ).join("");
  togglePanel("entregas", `<h3> Entregas actuales</h3>
    <table><thead><tr><th>De</th><th>Para</th><th>Trigo</th><th>Hierro</th><th>Hora</th></tr></thead><tbody>${filas}</tbody></table>`);
};

document.getElementById("btnHistorialEstados").onclick = () => {
  const hist = ultimoEstado.historialEstados || [];
  const filas = hist.map((h,i) =>
    `<tr><td>${h.sesion ?? i+1}</td><td>${h.jugador ?? "-"}</td><td>${h.trigo ?? "-"}</td><td>${h.hierro ?? "-"}</td></tr>`
  ).join("");
  togglePanel("histEstados", `<h3> Historial de estados</h3>
    <table><thead><tr><th>Sesi贸n</th><th>Jugador</th><th>Trigo</th><th>Hierro</th></tr></thead><tbody>${filas}</tbody></table>`);
};

document.getElementById("btnHistorialEntregas").onclick = () => {
  const hist = ultimoEstado.historial || [];
  const filas = hist.map((h,i) =>
    `<tr><td>${h.sesion ?? i+1}</td><td>${h.de}</td><td>${h.para}</td><td>${h.trigo}</td><td>${h.hierro}</td><td>${h.hora}</td></tr>`
  ).join("");
  togglePanel("histEntregas", `<h3> Historial de entregas</h3>
    <table><thead><tr><th>Sesi贸n</th><th>De</th><th>Para</th><th>Trigo</th><th>Hierro</th><th>Hora</th></tr></thead><tbody>${filas}</tbody></table>`);
};
</script>
</body>
</html>
