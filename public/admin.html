<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Panel del Administrador</title>
<script src="/socket.io/socket.io.js"></script>
<style>
  body { font-family: Arial; margin: 20px; background: #f4f6f8; color: #222; }
  h2 { margin-bottom: 10px; }
  table { border-collapse: collapse; width: 100%; background: white; margin-top: 10px; }
  th, td { border: 1px solid #ccc; padding: 6px; text-align: center; }
  .boton { margin: 5px; padding: 6px 10px; border: none; border-radius: 6px; cursor: pointer; background: #1976d2; color: white; }
  .boton:hover { background: #1565c0; }
  .panel { display: none; margin-top: 10px; }
  .info-box { background: white; padding: 10px; border-radius: 8px; margin-top: 10px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
  .botonera { text-align: center; margin-top: 15px; }
  .status-bar { margin-top: 10px; font-weight: bold; }
  .abierto { color: green; }
  .cerrado { color: red; }
</style>
</head>
<body>

<h2>Panel del Administrador</h2>

<div class="info-box">
  <p><b>Sala:</b> <span id="nombreSala">â€”</span></p>
  <div class="status-bar">
    Entregas: <span id="estadoEntregas" class="cerrado">Desconocido</span> |
    ProducciÃ³n: <span id="estadoProduccion" class="cerrado">Desconocido</span>
  </div>
</div>

<div class="botonera">
  <button class="boton" id="btnEstados">ðŸ“Š Estados actuales</button>
  <button class="boton" id="btnEntregasAct">ðŸ“œ Entregas actuales</button>
  <button class="boton" id="btnHistorialEstados">ðŸ“ˆ Historial de estados</button>
  <button class="boton" id="btnHistorialEntregas">ðŸ“š Historial de entregas</button>
</div>

<div id="panelDatos" class="panel info-box">
  <div id="contenidoPanel"></div>
</div>

<div class="info-box" style="margin-top:20px;">
  <h3>Control general</h3>
  <button id="abrirProduccion" class="boton">Abrir producciÃ³n</button>
  <button id="cerrarProduccion" class="boton">Cerrar producciÃ³n</button>
  <button id="abrirEntregas" class="boton">Abrir entregas</button>
  <button id="cerrarEntregas" class="boton">Cerrar entregas</button>
  <button id="avanzarTurno" class="boton">Avanzar turno</button>
</div>

<script>
const socket = io();
let ultimoEstado = {};
let panelVisible = null;
let sala = "principal";

// === Mostrar/ocultar panel ===
function togglePanel(id, html) {
  const panel = document.getElementById("panelDatos");
  const contenido = document.getElementById("contenidoPanel");
  if (panelVisible === id) {
    panel.style.display = "none";
    panelVisible = null;
  } else {
    contenido.innerHTML = html;
    panel.style.display = "block";
    panelVisible = id;
  }
}

// === Estado recibido ===
socket.on("estadoSala", data => {
  ultimoEstado = data;
  document.getElementById("nombreSala").textContent = data.sala || "principal";

  const prodAbierta = data.produccionAbierta;
  const entAbierta = data.entregasAbiertas;

  document.getElementById("estadoProduccion").textContent = prodAbierta ? "Abierta" : "Cerrada";
  document.getElementById("estadoProduccion").className = prodAbierta ? "abierto" : "cerrado";
  document.getElementById("estadoEntregas").textContent = entAbierta ? "Abiertas" : "Cerradas";
  document.getElementById("estadoEntregas").className = entAbierta ? "abierto" : "cerrado";
});

// === Botones principales ===
document.getElementById("btnEstados").onclick = () => {
  if (!ultimoEstado.jugadores) return;
  const filas = Object.entries(ultimoEstado.jugadores).map(([n,j]) =>
    `<tr><td>${n}</td><td>${j.trigo.toFixed(2)}</td><td>${j.hierro.toFixed(2)}</td><td>${j.entregas}</td><td>${j.proceso ?? "-"}</td></tr>`
  ).join("");
  const html = `<h3>ðŸ“Š Estados actuales</h3>
  <table><thead><tr><th>Jugador</th><th>Trigo</th><th>Hierro</th><th>Entregas</th><th>Proceso</th></tr></thead><tbody>${filas}</tbody></table>`;
  togglePanel("estados", html);
};

document.getElementById("btnEntregasAct").onclick = () => {
  const historial = ultimoEstado.historial || [];
  const filas = historial.map(h =>
    `<tr><td>${h.de}</td><td>${h.para}</td><td>${h.trigo}</td><td>${h.hierro}</td><td>${h.hora}</td></tr>`
  ).join("");
  const html = `<h3>ðŸ“œ Entregas actuales</h3>
  <table><thead><tr><th>De</th><th>Para</th><th>Trigo</th><th>Hierro</th><th>Hora</th></tr></thead><tbody>${filas}</tbody></table>`;
  togglePanel("entregasAct", html);
};

document.getElementById("btnHistorialEstados").onclick = () => {
  const hist = ultimoEstado.historialEstados || [];
  const filas = hist.map(h =>
    `<tr><td>${h.sesion ?? h.turno ?? "-"}</td><td>${h.jugador ?? "-"}</td><td>${h.trigo ?? "-"}</td><td>${h.hierro ?? "-"}</td></tr>`
  ).join("");
  const html = `<h3>ðŸ“ˆ Historial de estados</h3>
  <table><thead><tr><th>SesiÃ³n</th><th>Jugador</th><th>Trigo</th><th>Hierro</th></tr></thead><tbody>${filas || "<tr><td colspan='4'>Sin datos</td></tr>"}</tbody></table>`;
  togglePanel("histEstados", html);
};

document.getElementById("btnHistorialEntregas").onclick = () => {
  const hist = ultimoEstado.historial || [];
  const filas = hist.map((h,i) =>
    `<tr><td>${h.sesion ?? i+1}</td><td>${h.de}</td><td>${h.para}</td><td>${h.trigo}</td><td>${h.hierro}</td><td>${h.hora}</td></tr>`
  ).join("");
  const html = `<h3>ðŸ“š Historial de entregas</h3>
  <table><thead><tr><th>SesiÃ³n</th><th>De</th><th>Para</th><th>Trigo</th><th>Hierro</th><th>Hora</th></tr></thead><tbody>${filas || "<tr><td colspan='6'>Sin datos</td></tr>"}</tbody></table>`;
  togglePanel("histEntregas", html);
};

// === Botones de control general ===
document.getElementById("abrirProduccion").onclick = () => socket.emit("abrirProduccion", sala);
document.getElementById("cerrarProduccion").onclick = () => socket.emit("cerrarProduccion", sala);
document.getElementById("abrirEntregas").onclick = () => socket.emit("abrirEntregas", sala);
document.getElementById("cerrarEntregas").onclick = () => socket.emit("cerrarEntregas", sala);
document.getElementById("avanzarTurno").onclick = () => socket.emit("avanzarTurno", sala);

// === Solicitar estado inicial ===
socket.emit("pedirEstadoAdmin", sala);
</script>
</body>
</html>
