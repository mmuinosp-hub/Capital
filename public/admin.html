<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Consola Administrador</title>
<script src="/socket.io/socket.io.js"></script>
<style>
  body { font-family: sans-serif; margin: 20px; }
  table { border-collapse: collapse; width: 100%; margin-top: 10px; }
  th, td { border: 1px solid #aaa; padding: 5px; text-align: center; }
  input, select, button { margin: 5px; }
</style>
</head>
<body>
<h1>Consola Administrador</h1>

<div>
  <label>Sala: <input id="roomId" /></label>
  <label>Contrase침a: <input type="password" id="password" /></label>
  <button id="loginBtn">Entrar</button>
</div>

<div id="controls" style="display:none;">
  <h2>Jugadores</h2>
  <table id="playersTable">
    <tr><th>Jugador</th><th>Trigo</th><th>Hierro</th><th>Entregas</th><th>Proceso</th><th>Prod Trigo</th><th>Prod Hierro</th></tr>
  </table>

  <h3>Crear jugador</h3>
  <label>Nombre: <input id="nuevoNombre" /></label>
  <label>Contrase침a: <input id="nuevoPass" /></label>
  <label>Trigo: <input id="nuevoTrigo" type="number" /></label>
  <label>Hierro: <input id="nuevoHierro" type="number" /></label>
  <button id="crearJugadorBtn">Crear</button>

  <h3>Fases</h3>
  <button id="abrirEntregas">Abrir Entregas</button>
  <button id="cerrarEntregas">Cerrar Entregas</button>
  <button id="abrirProduccion">Abrir Producci칩n</button>
  <button id="concluirProduccion">Concluir Producci칩n</button>

  <h3>Historial de Entregas</h3>
  <table id="historialTable">
    <tr><th>De</th><th>Para</th><th>Trigo</th><th>Hierro</th><th>Hora</th></tr>
  </table>
</div>

<script>
const socket = io();
let roomId;

document.getElementById("loginBtn").onclick = () => {
  roomId = document.getElementById("roomId").value;
  const password = document.getElementById("password").value;
  socket.emit("loginAdmin", { roomId, password }, res => {
    if(res.success) document.getElementById("controls").style.display = "block";
    else alert(res.message);
  });
};

document.getElementById("crearJugadorBtn").onclick = () => {
  const nombre = document.getElementById("nuevoNombre").value;
  const password = document.getElementById("nuevoPass").value;
  const trigo = parseFloat(document.getElementById("nuevoTrigo").value) || 0;
  const hierro = parseFloat(document.getElementById("nuevoHierro").value) || 0;
  socket.emit("crearJugador", { roomId, nombre, password, trigo, hierro }, res => {
    if(!res.success) alert(res.message);
  });
};

document.getElementById("abrirEntregas").onclick = () => socket.emit("setFase", { roomId, fase:"entregas" });
document.getElementById("cerrarEntregas").onclick = () => socket.emit("setFase", { roomId, fase:"espera" });
document.getElementById("abrirProduccion").onclick = () => socket.emit("setFase", { roomId, fase:"produccion" });
document.getElementById("concluirProduccion").onclick = () => socket.emit("concluirProduccion", { roomId });

socket.on("updatePlayers", jugadores => {
  const table = document.getElementById("playersTable");
  table.innerHTML = '<tr><th>Jugador</th><th>Trigo</th><th>Hierro</th><th>Entregas</th><th>Proceso</th><th>Prod Trigo</th><th>Prod Hierro</th></tr>';
  for(let nombre in jugadores) {
    const j = jugadores[nombre];
    const row = `<tr>
      <td>${nombre}</td>
      <td>${j.trigo}</td>
      <td>${j.hierro}</td>
      <td>${j.entregas}</td>
      <td>${j.proceso || ""}</td>
      <td>${j.trigoProd}</td>
      <td>${j.hierroProd}</td>
    </tr>`;
    table.innerHTML += row;
  }
});

socket.on("updateHistorial", historial => {
  const table = document.getElementById("historialTable");
  table.innerHTML = '<tr><th>De</th><th>Para</th><th>Trigo</th><th>Hierro</th><th>Hora</th></tr>';
  historial.forEach(e => {
    table.innerHTML += `<tr>
      <td>${e.from}</td>
      <td>${e.to}</td>
      <td>${e.trigo}</td>
      <td>${e.hierro}</td>
      <td>${e.timestamp}</td>
    </tr>`;
  });
});
</script>
</body>
</html>
