<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Consola del Administrador</title>
<script src="/socket.io/socket.io.js"></script>
<style>
  body { font-family: Arial; margin: 20px; background: #f9f9f9; }
  table { border-collapse: collapse; width: 100%; background: white; }
  th, td { border: 1px solid #999; padding: 5px; text-align: center; }
  .boton { margin: 5px; padding: 6px 10px; border: none; background: #1976d2; color: white; border-radius: 6px; cursor: pointer; }
  .boton:hover { background: #1565c0; }
  .panel { display: none; margin-top: 10px; }
  .seccion { margin-top: 20px; background: white; padding: 12px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
  iframe { width: 100%; height: 400px; border: 1px solid #ccc; border-radius: 8px; }
  #panelGestion, #panelAcceso { display: none; }
  .estado-abierto { color: green; font-weight: bold; }
  .estado-cerrado { color: red; font-weight: bold; }
</style>
</head>
<body>

<h2>Consola del Administrador</h2>

<!-- === MEN√ö INICIAL === -->
<div id="panelInicio">
  <button class="boton" id="btnCrearSala">‚ûï Crear nueva sala</button>
  <button class="boton" id="btnAccederSala">üîë Acceder a sala existente</button>
</div>

<!-- === FORMULARIO DE ACCESO / CREACI√ìN === -->
<div id="panelAcceso">
  <h3 id="tituloAcceso"></h3>
  <form id="formAcceso">
    <label>Nombre de sala:</label>
    <input type="text" id="nombreSalaInput" required><br><br>
    <label>Contrase√±a:</label>
    <input type="password" id="passwordSalaInput" required><br><br>
    <button type="submit" class="boton">Entrar</button>
  </form>
</div>

<!-- === PANEL PRINCIPAL DE GESTI√ìN === -->
<div id="panelGestion">

  <h3>Sala: <span id="nombreSala"></span></h3>

  <!-- === ESTADO ACTUAL Y CONTROLES === -->
  <div class="seccion">
    <h3>Estado actual</h3>
    <p>Entregas: <span id="estadoEntregas" class="estado-cerrado">‚Äî</span></p>
    <p>Producci√≥n: <span id="estadoProduccion" class="estado-cerrado">‚Äî</span></p>

    <div style="margin-top:10px;">
      <button class="boton" id="toggleEntregas">Abrir/Cerrar entregas</button>
      <button class="boton" id="toggleProduccion">Abrir/Cerrar producci√≥n</button>
      <button class="boton" id="nuevaSesion">Nueva sesi√≥n</button>
    </div>
  </div>

  <!-- === CREACI√ìN DE JUGADORES === -->
  <div class="seccion">
    <h3>Crear jugador</h3>
    <form id="formJugador">
      Nombre: <input id="nombreJugador" required>
      Contrase√±a: <input id="passwordJugador" required>
      Trigo inicial: <input id="trigoInicial" type="number" min="0" step="any" required>
      Hierro inicial: <input id="hierroInicial" type="number" min="0" step="any" required>
      <button type="submit" class="boton">A√±adir jugador</button>
    </form>
  </div>

  <!-- === LISTA DE JUGADORES === -->
  <div class="seccion">
    <h3>Jugadores en la sala</h3>
    <table>
      <thead>
        <tr><th>Nombre</th><th>Trigo</th><th>Hierro</th><th>Entregas</th><th>Proceso</th></tr>
      </thead>
      <tbody id="tablaJugadores"></tbody>
    </table>
  </div>

  <!-- === HISTORIALES Y ENTREGAS === -->
  <div class="seccion">
    <h3>Consultas</h3>
    <button class="boton" id="btnEntregas">üìú Ver entregas actuales</button>
    <div id="panelEntregas" class="panel">
      <iframe id="iframeEntregas" src=""></iframe>
    </div>

    <button class="boton" id="btnHistorialEstados">üìà Ver historial de estados</button>
    <div id="panelHistorialEstados" class="panel">
      <iframe id="iframeHistorialEstados" src=""></iframe>
    </div>

    <button class="boton" id="btnHistorialEntregas">üìö Ver historial de entregas</button>
    <div id="panelHistorialEntregas" class="panel">
      <iframe id="iframeHistorialEntregas" src=""></iframe>
    </div>
  </div>

</div>

<script>
const socket = io();

let modoAcceso = null;
let salaActual = null;
let adminPassword = null;

// --- Pantalla inicial ---
document.getElementById("btnCrearSala").onclick = () => {
  modoAcceso = "crear";
  document.getElementById("panelInicio").style.display = "none";
  document.getElementById("panelAcceso").style.display = "block";
  document.getElementById("tituloAcceso").textContent = "Crear nueva sala";
};

document.getElementById("btnAccederSala").onclick = () => {
  modoAcceso = "acceder";
  document.getElementById("panelInicio").style.display = "none";
  document.getElementById("panelAcceso").style.display = "block";
  document.getElementById("tituloAcceso").textContent = "Acceder a sala existente";
};

// --- Env√≠o del formulario de acceso / creaci√≥n ---
document.getElementById("formAcceso").onsubmit = e => {
  e.preventDefault();
  const sala = document.getElementById("nombreSalaInput").value.trim();
  const password = document.getElementById("passwordSalaInput").value.trim();
  salaActual = sala;
  adminPassword = password;

  if (modoAcceso === "crear") {
    socket.emit("crearSala", { sala, password });
  } else {
    socket.emit("entrarAdmin", { sala, password });
  }
};

// --- Crear jugador ---
document.getElementById("formJugador").onsubmit = e => {
  e.preventDefault();
  const nombre = document.getElementById("nombreJugador").value.trim();
  const password = document.getElementById("passwordJugador").value.trim();
  const trigo = parseFloat(document.getElementById("trigoInicial").value);
  const hierro = parseFloat(document.getElementById("hierroInicial").value);

  if (!nombre || !password) return alert("Faltan datos del jugador");
  socket.emit("crearJugador", { sala: salaActual, nombre, password, trigo, hierro });
  e.target.reset();
};

// --- Control del juego ---
document.getElementById("toggleEntregas").onclick = () => socket.emit("toggleEntregas", salaActual);
document.getElementById("toggleProduccion").onclick = () => socket.emit("toggleProduccion", salaActual);
document.getElementById("nuevaSesion").onclick = () => socket.emit("nuevaSesion", salaActual);

// --- Eventos del servidor ---
socket.on("salaCreada", s => {
  socket.emit("entrarAdmin", { sala: s, password: adminPassword });
});

socket.on("adminEntrado", s => mostrarPanelGestion(s));

socket.on("actualizarEstado", data => {
  if (!data || !data.jugadores) return;
  const tbody = document.getElementById("tablaJugadores");
  tbody.innerHTML = "";
  for (const [nombre, j] of Object.entries(data.jugadores)) {
    tbody.innerHTML += `
      <tr>
        <td>${nombre}</td>
        <td>${j.trigo.toFixed(2)}</td>
        <td>${j.hierro.toFixed(2)}</td>
        <td>${j.entregas}</td>
        <td>${j.proceso ?? "-"}</td>
      </tr>`;
  }

  // Mostrar estado actual
  const eAb = document.getElementById("estadoEntregas");
  const pAb = document.getElementById("estadoProduccion");

  if (data.entregasAbiertas) {
    eAb.textContent = "üü¢ Abiertas";
    eAb.className = "estado-abierto";
  } else {
    eAb.textContent = "üî¥ Cerradas";
    eAb.className = "estado-cerrado";
  }

  if (data.produccionAbierta) {
    pAb.textContent = "üü¢ Abierta";
    pAb.className = "estado-abierto";
  } else {
    pAb.textContent = "üî¥ Cerrada";
    pAb.className = "estado-cerrado";
  }
});

// --- Mostrar panel principal ---
function mostrarPanelGestion(sala) {
  document.getElementById("panelAcceso").style.display = "none";
  document.getElementById("panelGestion").style.display = "block";
  document.getElementById("nombreSala").textContent = sala;
}

// --- Paneles desplegables con iframes funcionales ---
function togglePanel(id, iframeId, src) {
  const panel = document.getElementById(id);
  const iframe = document.getElementById(iframeId);
  if (panel.style.display === "none" || panel.style.display === "") {
    iframe.src = src;
    panel.style.display = "block";
  } else {
    panel.style.display = "none";
  }
}

document.getElementById("btnEntregas").onclick = () =>
  togglePanel("panelEntregas", "iframeEntregas", "entregas_realizadas.html");

document.getElementById("btnHistorialEstados").onclick = () =>
  togglePanel("panelHistorialEstados", "iframeHistorialEstados", "historial_estados.html");

document.getElementById("btnHistorialEntregas").onclick = () =>
  togglePanel("panelHistorialEntregas", "iframeHistorialEntregas", "historial_entregas.html");

socket.on("error", msg => alert("‚ö†Ô∏è " + msg));
</script>

</body>
</html>
