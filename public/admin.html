<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Consola del Administrador</title>
<script src="/socket.io/socket.io.js"></script>
<style>
  body { font-family: Arial; margin: 20px; background: #f8f9fa; }
  .seccion { background: #fff; padding: 12px; border-radius: 8px; box-shadow: 0 2px 6px rgba(0,0,0,0.1); margin-bottom: 16px; }
  h2,h3{margin-top:0;}
  table { border-collapse: collapse; width: 100%; background: white; }
  th, td { border: 1px solid #ccc; padding: 6px; text-align: center; }
  .boton { background: #1976d2; color: #fff; border: none; padding: 6px 12px; border-radius: 6px; cursor: pointer; margin: 4px; }
  .boton:hover { background: #125aa0; }
  .gris { background: #ccc; cursor: not-allowed; }
  .abierto { color: green; font-weight: bold; }
  .cerrado { color: red; font-weight: bold; }
  .panel { display: none; margin-top: 10px; }
  iframe { width: 100%; height: 350px; border: 1px solid #ccc; border-radius: 8px; }
</style>
</head>
<body>

<h2>Consola del Administrador</h2>

<!-- === Paso 1: elegir modo === -->
<div id="panelModo">
  <button class="boton" onclick="elegirModo('crear')">➕ Crear nueva sala</button>
  <button class="boton" onclick="elegirModo('entrar')">🔑 Entrar en sala existente</button>
</div>

<!-- === Paso 2: formulario de acceso === -->
<div id="panelAcceso" style="display:none;">
  <h3 id="tituloAcceso"></h3>
  <form id="formAcceso">
    <label>Nombre de sala:</label><br>
    <input type="text" id="nombreSalaInput" required><br><br>
    <label>Contraseña:</label><br>
    <input type="password" id="passwordSalaInput" required><br><br>
    <button type="submit" class="boton">Entrar</button>
  </form>
</div>

<!-- === Paso 3: panel de gestión === -->
<div id="panelGestion" style="display:none;">
  <div class="seccion">
    <h3>Sala: <span id="nombreSala"></span></h3>
    <p>Entregas: <span id="estadoEntregas" class="cerrado">—</span> | 
       Producción: <span id="estadoProduccion" class="cerrado">—</span></p>
    <div>
      <button id="abrirEntregas" class="boton">🟢 Abrir entregas</button>
      <button id="cerrarEntregas" class="boton">🔴 Cerrar entregas</button>
      <button id="abrirProduccion" class="boton">🟢 Abrir producción</button>
      <button id="cerrarProduccion" class="boton">🔴 Cerrar producción</button>
      <button id="nuevaSesion" class="boton">🔁 Nueva sesión</button>
    </div>
  </div>

  <!-- Crear jugadores -->
  <div class="seccion">
    <h3>Crear jugador</h3>
    <form id="formJugador">
      Nombre: <input id="nombreJugador" required>
      Contraseña: <input id="passwordJugador" required>
      Trigo inicial: <input id="trigoInicial" type="number" min="0" step="any" required>
      Hierro inicial: <input id="hierroInicial" type="number" min="0" step="any" required>
      <button type="submit" class="boton">Añadir jugador</button>
    </form>
  </div>

  <!-- Jugadores -->
  <div class="seccion">
    <h3>Jugadores en la sala</h3>
    <table>
      <thead><tr><th>Nombre</th><th>Trigo</th><th>Hierro</th><th>Entregas</th><th>Proceso</th></tr></thead>
      <tbody id="tablaJugadores"></tbody>
    </table>
  </div>

  <!-- Consultas -->
  <div class="seccion">
    <h3>Consultas</h3>
    <div>
      <button class="boton" id="btnEstados">📊 Estados actuales</button>
      <button class="boton" id="btnEntregas">📜 Entregas actuales</button>
      <button class="boton" id="btnHistorialEstados">📈 Historial de estados</button>
      <button class="boton" id="btnHistorialEntregas">📚 Historial de entregas</button>
    </div>

    <div id="panelEstados" class="panel"><iframe src="estado_jugadores.html"></iframe></div>
    <div id="panelEntregas" class="panel"><iframe src="entregas_realizadas.html"></iframe></div>
    <div id="panelHistorialEstados" class="panel"><iframe src="historial_estados.html"></iframe></div>
    <div id="panelHistorialEntregas" class="panel"><iframe src="historial_entregas.html"></iframe></div>
  </div>
</div>

<script>
const socket = io();
let modo = null;
let salaActual = null;
let adminPassword = null;
let ultimoEstado = {};

function elegirModo(m) {
  modo = m;
  document.getElementById("panelModo").style.display = "none";
  document.getElementById("panelAcceso").style.display = "block";
  document.getElementById("tituloAcceso").textContent =
    m === "crear" ? "Crear nueva sala" : "Entrar en sala existente";
}

// === Acceso / creación ===
document.getElementById("formAcceso").onsubmit = e => {
  e.preventDefault();
  salaActual = document.getElementById("nombreSalaInput").value.trim();
  adminPassword = document.getElementById("passwordSalaInput").value.trim();
  if (modo === "crear") socket.emit("crearSala", { sala: salaActual, password: adminPassword });
  else socket.emit("entrarAdmin", { sala: salaActual, password: adminPassword });
};

// === Crear jugador ===
document.getElementById("formJugador").onsubmit = e => {
  e.preventDefault();
  const nombre = document.getElementById("nombreJugador").value.trim();
  const password = document.getElementById("passwordJugador").value.trim();
  const trigo = parseFloat(document.getElementById("trigoInicial").value);
  const hierro = parseFloat(document.getElementById("hierroInicial").value);
  socket.emit("crearJugador", { sala: salaActual, nombre, password, trigo, hierro });
  e.target.reset();
};

// === Controles ===
document.getElementById("abrirEntregas").onclick = () => cambiarEstado("entregasAbiertas", true);
document.getElementById("cerrarEntregas").onclick = () => cambiarEstado("entregasAbiertas", false);
document.getElementById("abrirProduccion").onclick = () => cambiarEstado("produccionAbierta", true);
document.getElementById("cerrarProduccion").onclick = () => cambiarEstado("produccionAbierta", false);
document.getElementById("nuevaSesion").onclick = () => socket.emit("nuevaSesion", salaActual);

function cambiarEstado(prop, valor) {
  if (!salaActual) return;
  ultimoEstado[prop] = valor;
  const el = document.getElementById(prop === "entregasAbiertas" ? "estadoEntregas" : "estadoProduccion");
  el.textContent = valor ? "🟢 Abiertas" : "🔴 Cerradas";
  el.className = valor ? "abierto" : "cerrado";
  socket.emit("toggleEstado", { sala: salaActual, prop, valor });
}

// === Eventos ===
socket.on("salaCreada", s => socket.emit("entrarAdmin", { sala: s, password: adminPassword }));

socket.on("adminEntrado", s => {
  document.getElementById("panelAcceso").style.display = "none";
  document.getElementById("panelGestion").style.display = "block";
  document.getElementById("nombreSala").textContent = s;
});

socket.on("actualizarEstado", data => {
  ultimoEstado = data;
  const tbody = document.getElementById("tablaJugadores");
  tbody.innerHTML = "";
  for (const [nombre, j] of Object.entries(data.jugadores)) {
    tbody.innerHTML += `<tr><td>${nombre}</td><td>${j.trigo.toFixed(2)}</td>
      <td>${j.hierro.toFixed(2)}</td><td>${j.entregas}</td><td>${j.proceso ?? "-"}</td></tr>`;
  }
  const eAb = document.getElementById("estadoEntregas");
  const pAb = document.getElementById("estadoProduccion");
  eAb.textContent = data.entregasAbiertas ? "🟢 Abiertas" : "🔴 Cerradas";
  eAb.className = data.entregasAbiertas ? "abierto" : "cerrado";
  pAb.textContent = data.produccionAbierta ? "🟢 Abierta" : "🔴 Cerrada";
  pAb.className = data.produccionAbierta ? "abierto" : "cerrado";
});

socket.on("error", msg => alert("⚠️ " + msg));

// === Paneles desplegables ===
function togglePanel(id) {
  const p = document.getElementById(id);
  p.style.display = p.style.display === "block" ? "none" : "block";
}

document.getElementById("btnEstados").onclick = () => togglePanel("panelEstados");
document.getElementById("btnEntregas").onclick = () => togglePanel("panelEntregas");
document.getElementById("btnHistorialEstados").onclick = () => togglePanel("panelHistorialEstados");
document.getElementById("btnHistorialEntregas").onclick = () => togglePanel("panelHistorialEntregas");
</script>

</body>
</html>
