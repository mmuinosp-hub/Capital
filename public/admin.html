<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Administrador</title>
<script src="/socket.io/socket.io.js"></script>
</head>
<body>
<h1>Consola Administrador</h1>

<div id="login">
  <input id="roomId" placeholder="Room ID"><br>
  <input id="password" placeholder="Contraseña" type="password"><br>
  <button onclick="login()">Entrar</button>
</div>

<div id="panel" style="display:none;">
  <h2>Sala: <span id="sala"></span></h2>

  <h3>Crear jugador</h3>
  <input id="nombreJugador" placeholder="Nombre">
  <input id="passwordJugador" placeholder="Contraseña" type="password">
  <input id="trigo" type="number" placeholder="Trigo inicial">
  <input id="hierro" type="number" placeholder="Hierro inicial">
  <button onclick="crearJugador()">Crear jugador</button>

  <h3>Fase del juego</h3>
  <button onclick="setFase('entregas')">Abrir entregas</button>
  <button onclick="setFase('produccion')">Abrir producción</button>

  <h2>Jugadores</h2>
  <table border="1">
    <thead>
      <tr>
        <th>Jugador</th>
        <th>Trigo</th>
        <th>Hierro</th>
        <th>Entregas</th>
        <th>Proceso</th>
        <th>Prod Trigo</th>
        <th>Prod Hierro</th>
      </tr>
    </thead>
    <tbody id="tabla"></tbody>
  </table>

  <h2>Historial de Entregas</h2>
  <table border="1">
    <thead>
      <tr><th>De</th><th>Para</th><th>Recurso</th><th>Cantidad</th><th>Hora</th></tr>
    </thead>
    <tbody id="historial"></tbody>
  </table>
</div>

<script>
const socket = io();
let roomId;

function login() {
  roomId = document.getElementById("roomId").value;
  const password = document.getElementById("password").value;
  socket.emit("loginAdmin", { roomId, password }, res => {
    if (res.success) {
      document.getElementById("login").style.display = "none";
      document.getElementById("panel").style.display = "block";
      document.getElementById("sala").innerText = roomId;
    } else alert(res.message);
  });
}

function crearJugador() {
  const nombre = document.getElementById("nombreJugador").value;
  const password = document.getElementById("passwordJugador").value;
  const trigo = document.getElementById("trigo").value;
  const hierro = document.getElementById("hierro").value;
  socket.emit("crearJugador", { roomId, nombre, password, trigo, hierro }, res => {
    if (res.success) {
      document.getElementById("nombreJugador").value = "";
      document.getElementById("passwordJugador").value = "";
      document.getElementById("trigo").value = "";
      document.getElementById("hierro").value = "";
    } else alert(res.message);
  });
}

function setFase(fase) {
  socket.emit("setFase", { roomId, fase }, () => {});
}

function renderTabla(players) {
  const tbody = document.getElementById("tabla");
  tbody.innerHTML = "";
  Object.keys(players).forEach(n => {
    const p = players[n];
    const row = document.createElement("tr");
    row.innerHTML = `
      <td>${n}</td>
      <td>${p.trigo.toFixed(1)}</td>
      <td>${p.hierro.toFixed(1)}</td>
      <td>${p.entregas}/5</td>
      <td>${p.proceso || "-"}</td>
      <td>${p.trigoProd?.toFixed(1) || 0}</td>
      <td>${p.hierroProd?.toFixed(1) || 0}</td>`;
    tbody.appendChild(row);
  });
}

function renderHistorial(historial) {
  const tbody = document.getElementById("historial");
  tbody.innerHTML = "";
  historial.forEach(h => {
    const tr = document.createElement("tr");
    tr.innerHTML = `<td>${h.from}</td><td>${h.to}</td><td>${h.recurso}</td>
                    <td>${h.cantidad}</td><td>${h.timestamp}</td>`;
    tbody.appendChild(tr);
  });
}

socket.on("updatePlayers", renderTabla);
socket.on("updateHistorial", renderHistorial);
</script>
</body>
</html>
