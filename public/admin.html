<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Administrador - Simulador Capitalista</title>
<script src="/socket.io/socket.io.js"></script>
<style>
body { font-family: Arial, sans-serif; margin: 20px; background: #f8f9fa; }
h2,h3 { margin: 0 0 10px 0; }
button { padding: 8px 14px; border-radius: 8px; border: none; cursor: pointer; margin: 6px 4px; background:#1976d2; color:#fff; }
button:hover { background:#125aa0; }
button.secondary { background:#616161; }
table { border-collapse: collapse; width: 100%; margin-top:10px; }
th,td { border: 1px solid #ccc; padding: 6px; text-align:center; }
.seccion { background:#fff; padding:12px; border-radius:8px; box-shadow:0 2px 6px rgba(0,0,0,0.1); margin-bottom:16px; }
.oculto { display:none; }
.estado-abierto { color:green; font-weight:bold; }
.estado-cerrado { color:red; font-weight:bold; }
.panel { display:none; margin-top:10px; background:#fff; padding:12px; border-radius:8px; box-shadow:0 2px 6px rgba(0,0,0,0.1); }
</style>
</head>
<body>

<h2>Consola del Administrador</h2>

<!-- Inicio -->
<div id="panelInicio" class="seccion">
  <button class="boton" id="btnCrearSala">➕ Crear nueva sala</button>
  <button class="boton" id="btnAccederSala">🔑 Entrar a sala existente</button>
  <button class="boton secondary" onclick="window.location.href='/'">🏠 Volver a inicio</button>
</div>

<!-- Acceso/creación -->
<div id="panelAcceso" class="seccion oculto">
  <h3 id="tituloAcceso"></h3>
  <form id="formAcceso">
    <label>Nombre de sala:</label><br>
    <input type="text" id="nombreSalaInput" required><br><br>
    <label>Contraseña:</label><br>
    <input type="password" id="passwordSalaInput" required><br><br>
    <button type="submit" class="boton">Entrar</button>
  </form>
</div>

<!-- Panel principal -->
<div id="panelGestion" class="oculto">

  <h3>Sala: <span id="nombreSala"></span></h3>

  <div class="seccion">
    <h4>Estado actual</h4>
    <p>Entregas: <span id="estadoEntregas" class="estado-cerrado">—</span></p>
    <p>Producción: <span id="estadoProduccion" class="estado-cerrado">—</span></p>
    <button class="boton" id="toggleEntregas">Abrir/Cerrar entregas</button>
    <button class="boton" id="toggleProduccion">Abrir/Cerrar producción</button>
    <button class="boton" id="nuevaSesion">Nueva sesión</button>
  </div>

  <!-- Crear jugador -->
  <div class="seccion">
    <h4>Crear jugador</h4>
    <form id="formJugador">
      Nombre: <input id="nombreJugador" required>
      Contraseña: <input id="passwordJugador" required>
      Trigo inicial: <input id="trigoInicial" type="number" min="0" step="any" required>
      Hierro inicial: <input id="hierroInicial" type="number" min="0" step="any" required>
      <button type="submit" class="boton">Añadir jugador</button>
    </form>
  </div>

  <!-- Lista de jugadores -->
  <div class="seccion">
    <h4>Jugadores en la sala</h4>
    <table>
      <thead><tr><th>Nombre</th><th>Trigo</th><th>Hierro</th><th>Entregas</th><th>Proceso</th></tr></thead>
      <tbody id="tablaJugadores"></tbody>
    </table>
  </div>

  <!-- Botones de consulta -->
  <div class="seccion">
    <button class="boton" id="btnEstados">📊 Estados actuales</button>
    <button class="boton" id="btnEntregas">📜 Entregas actuales</button>
    <button class="boton" id="btnHistorialEstados">📈 Historial de estados</button>
    <button class="boton" id="btnHistorialEntregas">📚 Historial de entregas</button>

    <div id="panelEstados" class="panel"></div>
    <div id="panelEntregas" class="panel"></div>
    <div id="panelHistorialEstados" class="panel"></div>
    <div id="panelHistorialEntregas" class="panel"></div>
  </div>

</div>

<script>
const socket = io();
let salaActual="", adminPassword="";
let ultimoEstado={};
let panelVisible=null;

// --- Inicio ---
document.getElementById("btnCrearSala").onclick = ()=>{
  document.getElementById("panelInicio").classList.add("oculto");
  document.getElementById("panelAcceso").classList.remove("oculto");
  document.getElementById("tituloAcceso").textContent="Crear nueva sala";
};
document.getElementById("btnAccederSala").onclick = ()=>{
  document.getElementById("panelInicio").classList.add("oculto");
  document.getElementById("panelAcceso").classList.remove("oculto");
  document.getElementById("tituloAcceso").textContent="Entrar a sala existente";
};

document.getElementById("formAcceso").onsubmit = e=>{
  e.preventDefault();
  salaActual = document.getElementById("nombreSalaInput").value.trim();
  adminPassword = document.getElementById("passwordSalaInput").value.trim();
  const modo = document.getElementById("tituloAcceso").textContent.includes("Crear") ? "crear" : "acceder";
  if(modo==="crear") socket.emit("crearSala",{ sala:salaActual, password: adminPassword });
  else socket.emit("entrarAdmin",{ sala:salaActual, password: adminPassword });
};

socket.on("salaCreada", s=> socket.emit("entrarAdmin",{ sala:s, password: adminPassword }));
socket.on("adminEntrado", s=>{
  document.getElementById("panelAcceso").classList.add("oculto");
  document.getElementById("panelGestion").classList.remove("oculto");
  document.getElementById("nombreSala").textContent = s;
});

// --- Actualizar estado ---
socket.on("actualizarEstado", data=>{
  ultimoEstado=data;
  const tbody=document.getElementById("tablaJugadores");
  tbody.innerHTML="";
  for(const [nombre,j] of Object.entries(data.jugadores||{})){
    tbody.innerHTML+=`<tr><td>${nombre}</td><td>${j.trigo.toFixed(2)}</td><td>${j.hierro.toFixed(2)}</td><td>${j.entregas}</td><td>${j.proceso??"-"}</td></tr>`;
  }

  document.getElementById("estadoEntregas").textContent = data.entregasAbiertas?"🟢 Abiertas":"🔴 Cerradas";
  document.getElementById("estadoEntregas").className = data.entregasAbiertas?"estado-abierto":"estado-cerrado";
  document.getElementById("estadoProduccion").textContent = data.produccionAbierta?"🟢 Abierta":"🔴 Cerrada";
  document.getElementById("estadoProduccion").className = data.produccionAbierta?"estado-abierto":"estado-cerrado";
});

// --- Crear jugador ---
document.getElementById("formJugador").onsubmit = e=>{
  e.preventDefault();
  const nombre=document.getElementById("nombreJugador").value.trim();
  const password=document.getElementById("passwordJugador").value.trim();
  const trigo=parseFloat(document.getElementById("trigoInicial").value);
  const hierro=parseFloat(document.getElementById("hierroInicial").value);
  socket.emit("crearJugador",{ sala:salaActual, nombre, password, trigo, hierro });
  e.target.reset();
};

// --- Controles ---
document.getElementById("toggleEntregas").onclick = ()=>socket.emit("toggleEntregas",salaActual);
document.getElementById("toggleProduccion").onclick = ()=>socket.emit("toggleProduccion",salaActual);
document.getElementById("nuevaSesion").onclick = ()=>socket.emit("nuevaSesion",salaActual);

// --- Paneles desplegables ---
function togglePanel(id, html){
  const panel=document.getElementById(id);
  if(panelVisible===id){ panel.style.display="none"; panelVisible=null; return; }
  panel.innerHTML=html;
  panel.style.display="block";
  panelVisible=id;
}

// --- Botones de consulta ---
document.getElementById("btnEstados").onclick = ()=>{
  const filas = Object.entries(ultimoEstado.jugadores||{}).map(([n,j])=>`<tr><td>${n}</td><td>${j.trigo.toFixed(2)}</td><td>${j.hierro.toFixed(2)}</td><td>${j.entregas}</td><td>${j.proceso??"-"}</td></tr>`).join("");
  togglePanel("panelEstados", `<h3>📊 Estados actuales</h3><table><thead><tr><th>Jugador</th><th>Trigo</th><th>Hierro</th><th>Entregas</th><th>Proceso</th></tr></thead><tbody>${filas}</tbody></table>`);
};
document.getElementById("btnEntregas").onclick = ()=>{
  const hist = ultimoEstado.historial||[];
  const filas = hist.map(h=>`<tr><td>${h.de}</td><td>${h.para}</td><td>${h.trigo}</td><td>${h.hierro}</td><td>${h.hora}</td></tr>`).join("");
  togglePanel("panelEntregas", `<h3>📜 Entregas actuales</h3><table><thead><tr><th>De</th><th>Para</th><th>Trigo</th><th>Hierro</th><th>Hora</th></tr></thead><tbody>${filas}</tbody></table>`);
};
document.getElementById("btnHistorialEstados").onclick = ()=>{
  const hist = ultimoEstado.historialEstados||[];
  const filas = hist.map(h=>`<tr><td>${h.sesion??"-"}</td><td>${h.jugador??"-"}</td><td>${h.trigo??"-"}</td><td>${h.hierro??"-"}</td></tr>`).join("");
  togglePanel("panelHistorialEstados", `<h3>📈 Historial de estados</h3><table><thead><tr><th>Sesión</th><th>Jugador</th><th>Trigo</th><th>Hierro</th></tr></thead><tbody>${filas||"<tr><td colspan='4'>Sin datos</td></tr>"}</tbody></table>`);
};
document.getElementById("btnHistorialEntregas").onclick = ()=>{
  const hist = ultimoEstado.historial||[];
  const filas = hist.map((h,i)=>`<tr><td>${h.sesion??i+1}</td><td>${h.de}</td><td>${h.para}</td><td>${h.trigo}</td><td>${h.hierro}</td><td>${h.hora}</td></tr>`).join("");
  togglePanel("panelHistorialEntregas", `<h3>📚 Historial de entregas</h3><table><thead><tr><th>Sesión</th><th>De</th><th>Para</th><th>Trigo</th><th>Hierro</th><th>Hora</th></tr></thead><tbody>${filas||"<tr><td colspan='6'>Sin datos</td></tr>"}</tbody></table>`);
};

socket.on("error", msg=>alert("⚠️ "+msg));
</script>

</body>
</html>
